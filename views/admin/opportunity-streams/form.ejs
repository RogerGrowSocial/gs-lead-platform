<%
  const isEdit = !!stream
  const typeLabel = (t) => ({ trustoo: 'Trustoo', webhook: 'Generic Webhook', form: 'Website Form' }[t] || t)
  const configJson = stream && stream.config ? JSON.stringify(stream.config, null, 2) : '{\n  "mapping": {\n    "title": "payload.company_name",\n    "company_name": "payload.company_name",\n    "contact_name": "payload.contact_name",\n    "email": "payload.email",\n    "phone": "payload.phone",\n    "description": "payload.message"\n  },\n  "defaults": {\n    "status": "open",\n    "stage": "nieuw",\n    "priority": "medium"\n  }\n}'
%>
<%- include('../../layouts/admin', {
  title: isEdit ? 'Bewerken: ' + (stream.name || 'Stroom') : 'Nieuwe kansenstroom',
  activeMenu: 'opportunities',
  activeSubmenu: 'streams',
  user: user,
  body: `
  <div class="settings-container">
    <div class="page-header">
      <div>
        <a href="/admin/opportunities/streams" class="back-link"><i class="fas fa-arrow-left"></i> Terug naar kansenstromen</a>
        <h1>${isEdit ? 'Bewerken: ' + (stream.name || '') : 'Nieuwe kansenstroom'}</h1>
        <p class="text-muted">${isEdit ? 'Wijzig naam, type, actief en configuratie.' : 'Voeg een nieuwe bron voor kansen toe.'}</p>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-header">
        <h2>Algemeen</h2>
      </div>
      <div class="settings-card-body">
        <form id="streamForm" ${stream ? `data-stream-id="${stream.id}"` : ''}>
          <div class="form-group">
            <label for="name">Naam <span class="required">*</span></label>
            <input type="text" id="name" name="name" value="${stream ? (stream.name || '').replace(/"/g, '&quot;') : ''}" required placeholder="bijv. Trustoo Productie" class="form-control" />
          </div>
          <div class="form-group">
            <label for="type">Type <span class="required">*</span></label>
            <select id="type" name="type" required class="form-control" ${isEdit ? 'disabled' : ''}>
              <option value="trustoo" ${stream && stream.type === 'trustoo' ? 'selected' : ''}>Trustoo</option>
              <option value="webhook" ${stream && stream.type === 'webhook' ? 'selected' : ''}>Generic Webhook</option>
              <option value="form" ${stream && stream.type === 'form' ? 'selected' : ''}>Website Form</option>
            </select>
            ${isEdit ? '<p class="form-help">Type kan na aanmaken niet meer gewijzigd worden.</p>' : ''}
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="is_active" name="is_active" ${!stream || stream.is_active ? 'checked' : ''} /> Actief</label>
            <p class="form-help">Inactieve stromen accepteren geen nieuwe events.</p>
          </div>

          <div class="form-group" id="simpleMappingSection">
            <h3 class="form-section-title" style="margin-top: 0;">Veldkoppeling</h3>
            <p class="form-help" style="margin-bottom: 12px;">Geef de <strong>naam van het veld in de payload</strong> dat bij ons veld hoort. Laat leeg als de bron dat veld niet stuurt. Standaardwaarden (<code>company_name</code>, <code>email</code>, enz.) werken als de bron die namen gebruikt.</p>
            <div class="stream-mapping-grid" style="display: grid; gap: 12px; max-width: 480px;">
              <div class="form-group" style="margin-bottom: 0;">
                <label for="map_company_name">Bedrijfsnaam (payload-veld)</label>
                <input type="text" id="map_company_name" class="form-control" placeholder="company_name" />
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label for="map_contact_name">Contactnaam (payload-veld)</label>
                <input type="text" id="map_contact_name" class="form-control" placeholder="contact_name" />
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label for="map_email">E-mail (payload-veld)</label>
                <input type="text" id="map_email" class="form-control" placeholder="email" />
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label for="map_phone">Telefoon (payload-veld)</label>
                <input type="text" id="map_phone" class="form-control" placeholder="phone" />
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label for="map_message">Bericht / omschrijving (payload-veld)</label>
                <input type="text" id="map_message" class="form-control" placeholder="message" />
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label for="default_status">Standaard status nieuwe kans</label>
                <select id="default_status" class="form-control">
                  <option value="open">Open</option>
                  <option value="new">Nieuw</option>
                  <option value="qualified">Gekwalificeerd</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label for="default_priority">Standaard prioriteit</label>
                <select id="default_priority" class="form-control">
                  <option value="medium">Gemiddeld</option>
                  <option value="high">Hoog</option>
                  <option value="low">Laag</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-group">
            <button type="button" id="toggleAdvancedConfig" class="btn-outline" style="margin-bottom: 8px;">
              <i class="fas fa-code"></i> Geavanceerd: JSON bewerken
            </button>
            <div id="advancedConfigBlock" style="display: none;">
              <label for="config">Config (JSON)</label>
              <textarea id="config" name="config" rows="12" class="form-control" style="font-family: monospace; font-size: 13px;">${configJson}</textarea>
              <p class="form-help">Alleen aanpassen als je afwijkende veldnamen of geneste payloads hebt.</p>
            </div>
          </div>
          ${!isEdit ? `
          <div class="form-group">
            <label for="secret">Secret (optioneel)</label>
            <input type="password" id="secret" name="secret" placeholder="Laat leeg voor geen verificatie" class="form-control" autocomplete="new-password" />
            <p class="form-help">Bij ingest moet header X-Stream-Secret deze waarde hebben. Toon en kopieer na opslaan; daarna niet meer zichtbaar.</p>
          </div>
          ` : `
          <div class="form-group">
            <label>Secret</label>
            <p class="form-help">Bestaand secret wijzigen: vul hieronder een nieuw secret in en sla op. Of gebruik "Rotate secret" op de detailpagina.</p>
            <input type="password" id="secret" name="secret" placeholder="Nieuw secret (optioneel)" class="form-control" autocomplete="new-password" />
          </div>
          `}
          <div class="form-actions">
            <a href="/admin/opportunities/streams${isEdit ? '/' + stream.id : ''}" class="btn-outline">Annuleren</a>
            <button type="submit" class="btn-primary">${isEdit ? 'Opslaan' : 'Aanmaken'}</button>
          </div>
        </form>
      </div>
    </div>
    ${!isEdit ? `
    <div class="settings-card" id="afterCreateBlock" style="display: none;">
      <div class="settings-card-header">
        <h2>Webhook URL & secret</h2>
        <p class="settings-card-subtitle">Bewaar deze gegevens; het secret wordt daarna niet meer getoond.</p>
      </div>
      <div class="settings-card-body">
        <div class="form-group">
          <label>Webhook URL</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="text" id="webhookUrlDisplay" readonly class="form-control" style="flex: 1;" />
            <button type="button" id="copyWebhookUrlBtn" class="btn-outline"><i class="fas fa-copy"></i> Kopieer</button>
          </div>
        </div>
        <div class="form-group">
          <label>Secret (eenmalig zichtbaar)</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="text" id="secretDisplay" readonly class="form-control" style="flex: 1;" />
            <button type="button" id="copySecretBtn" class="btn-outline"><i class="fas fa-copy"></i> Kopieer</button>
          </div>
        </div>
        <p><a href="/admin/opportunities/streams" class="btn-primary">Naar overzicht</a></p>
      </div>
    </div>
    ` : ''}
  </div>
  `,
  scripts: typeof scripts !== 'undefined' ? scripts : ['/js/admin/opportunity-streams-form.js'],
  stylesheets: typeof stylesheets !== 'undefined' ? stylesheets : ['/css/opportunities.css']
}) %>
