<%
  const typeLabel = (t) => ({ trustoo: 'Trustoo', webhook: 'Generic Webhook', form: 'Website Form' }[t] || t)
  const base = typeof baseUrl !== 'undefined' ? baseUrl : ''
  const webhookUrl = base ? `${base}/api/ingest/opportunities/${stream.id}` : `/api/ingest/opportunities/${stream.id}`
%>
<%- include('../../layouts/admin', {
  title: stream.name + ' | Kansenstromen',
  activeMenu: 'opportunities',
  activeSubmenu: 'streams',
  user: user,
  body: `
  <div class="streams-page">
  <div class="settings-container" data-stream-id="${stream.id}">
    <div class="page-header">
      <div>
        <a href="/admin/opportunities/streams" class="back-link"><i class="fas fa-arrow-left"></i> Terug naar kansenstromen</a>
        <h1>${stream.name || 'Stroom'}</h1>
        <p class="text-muted">
          <span class="status-badge ${stream.is_active ? 'active' : 'expired'}">${stream.is_active ? 'Actief' : 'Inactief'}</span>
          <span class="status-badge pending">${typeLabel(stream.type)}</span>
        </p>
      </div>
      <div class="header-actions">
        <a href="/admin/opportunities/streams/${stream.id}/edit" class="btn-outline"><i class="fas fa-edit"></i> Bewerken</a>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-header">
        <h2>Webhook URL</h2>
        <p class="settings-card-subtitle">POST naar deze URL met JSON body. Stel header X-Stream-Secret in als je een secret hebt geconfigureerd.</p>
      </div>
      <div class="settings-card-body">
        <div class="webhook-url-box">
          <input type="text" id="webhookUrlDisplay" value="${webhookUrl}" readonly class="form-control" />
          <button type="button" id="copyWebhookUrlBtn" class="btn-outline"><i class="fas fa-copy"></i> Kopieer</button>
        </div>
        <p style="margin-top: 12px;"><button type="button" id="rotateSecretBtn" class="btn-outline"><i class="fas fa-key"></i> Rotate secret</button> <span id="rotateMessage" class="text-muted"></span></p>
      </div>
    </div>

    ${stream.type === 'trustoo' ? `
    <div class="settings-card stream-callout-trustoo">
      <div class="settings-card-header">
        <h2><i class="fas fa-plug"></i> Trustoo via Zapier</h2>
        <p class="settings-card-subtitle">Zo stuur je Trustoo-leads naar deze stroom.</p>
      </div>
      <div class="settings-card-body">
        <ol style="margin: 0; padding-left: 1.25rem;">
          <li><strong>Verbind Trustoo en Zapier</strong> via de link van Trustoo (bijv. zapier.com/developer/public-invite/...).</li>
          <li><strong>Maak een Zap:</strong> Trigger = <em>Trustoo → New Lead</em>. Bij Sign in de code van Trustoo invullen.</li>
          <li><strong>Action:</strong> App = <em>Webhooks by Zapier</em>, event = <em>POST</em>. URL = de Webhook URL hierboven. Payload Type = JSON. Body: koppel Trustoo-velden naar <code>company_name</code>, <code>contact_name</code>, <code>email</code>, <code>phone</code>, <code>message</code>. Header toevoegen: <code>X-Stream-Secret</code> = het secret van deze stroom.</li>
        </ol>
        <p style="margin-top: 12px; margin-bottom: 0;"><span class="text-muted">Volledige stappen staan in <code>docs/TRUSTOO-ZAPIER-KOPPELING.md</code> in de repository.</span></p>
      </div>
    </div>
    ` : ''}

    <div class="settings-card">
      <div class="settings-card-header">
        <h2>Mapping (config)</h2>
      </div>
      <div class="settings-card-body">
        <pre id="configDisplay" class="stream-config-pre">${JSON.stringify(stream.config || {}, null, 2)}</pre>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-header">
        <h2>Event logs (laatste 100)</h2>
        <p class="settings-card-subtitle">Filters</p>
        <div class="event-filters-row" style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; align-items: center;">
          <button type="button" class="event-filter-btn active" data-status="">Alles</button>
          <button type="button" class="event-filter-btn" data-status="success">Success</button>
          <button type="button" class="event-filter-btn" data-status="error">Errors</button>
          <button type="button" id="sendTestEventBtn" class="btn-primary"><i class="fas fa-paper-plane"></i> Test event versturen</button>
        </div>
      </div>
      <div class="settings-card-body">
        <div class="admins-table stream-events-table">
          <div class="admins-table-head">
            <div class="admins-row">
              <div class="admins-cell">Ontvangen</div>
              <div class="admins-cell">Status</div>
              <div class="admins-cell">HTTP</div>
              <div class="admins-cell">Idempotency</div>
              <div class="admins-cell">Kans</div>
              <div class="admins-cell">Fout</div>
              <div class="admins-cell actions-cell">Actie</div>
            </div>
          </div>
          <div class="admins-table-body" id="eventsTableBody">
            <div class="admins-row"><div class="admins-cell empty-state">Laden…</div></div>
          </div>
        </div>
        <div id="eventsPagination"></div>
      </div>
    </div>
  </div>

  <div id="payloadModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: #fff; border-radius: 8px; padding: 16px; max-width: 90vw; max-height: 80vh; overflow: auto;">
      <h3 style="margin: 0 0 12px;">Payload / Fout</h3>
      <pre id="payloadModalContent" style="background: #f5f5f5; padding: 12px; border-radius: 6px; overflow: auto; max-height: 60vh; white-space: pre-wrap; font-size: 12px;"></pre>
      <div style="margin-top: 12px;"><button type="button" class="btn-outline" onclick="document.getElementById('payloadModal').style.display='none'">Sluiten</button></div>
    </div>
  </div>

  <div id="secretModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: #fff; border-radius: 8px; padding: 20px; max-width: 480px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
      <h3 style="margin: 0 0 8px;">Nieuw secret</h3>
      <p class="text-muted" style="margin: 0 0 12px; font-size: 14px;">Bewaar dit secret; het wordt daarna niet meer getoond. Gebruik het als header <code>X-Stream-Secret</code> in Zapier of andere integraties.</p>
      <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 16px;">
        <input type="text" id="secretModalValue" readonly class="form-control" style="flex: 1; font-family: monospace;" />
        <button type="button" id="secretModalCopyBtn" class="btn-outline"><i class="fas fa-copy"></i> Kopieer</button>
      </div>
      <div style="display: flex; justify-content: flex-end;"><button type="button" id="secretModalCloseBtn" class="btn-primary">Sluiten</button></div>
    </div>
  </div>
  </div>
  `,
  scripts: typeof scripts !== 'undefined' ? scripts : ['/js/admin/opportunity-streams-detail.js'],
  stylesheets: typeof stylesheets !== 'undefined' ? stylesheets : ['/css/opportunities.css', '/css/admin/opportunity-streams.css']
}) %>
