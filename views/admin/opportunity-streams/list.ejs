<%
  const formatDate = (iso) => {
    if (!iso) return '—'
    return new Date(iso).toLocaleString('nl-NL', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })
  }
  const typeLabel = (t) => ({ trustoo: 'Trustoo', webhook: 'Generic Webhook', form: 'Website Form' }[t] || t)
%>
<%- include('../../layouts/admin', {
  title: 'Kansenstromen',
  activeMenu: 'opportunities',
  activeSubmenu: 'streams',
  user: user,
  body: `
  <div class="streams-page">
  <div class="settings-container">
    <div class="page-header">
      <div>
        <h1>Kansenstromen</h1>
        <p class="text-muted">Beheer bronnen die kansen genereren (Trustoo, Webhook, Formulier)</p>
      </div>
      <div class="header-actions">
        <a href="/admin/opportunities/streams/new" class="btn-primary">
          <i class="fas fa-plus"></i> Nieuwe stroom
        </a>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-header">
        <h2>Overzicht</h2>
        <p class="settings-card-subtitle">Actieve en inactieve stromen</p>
      </div>
      <div class="settings-card-body">
        <div class="admins-table">
          <div class="admins-table-head">
            <div class="admins-row">
              <div class="admins-cell">Naam</div>
              <div class="admins-cell">Type</div>
              <div class="admins-cell">Actief</div>
              <div class="admins-cell">Laatste event</div>
              <div class="admins-cell">Slagingspercentage (laatste 50)</div>
              <div class="admins-cell actions-cell">Acties</div>
            </div>
          </div>
          <div class="admins-table-body" id="streamsTableBody">
            ${ (streams || []).map(s => `
              <div class="admins-row" data-id="${s.id}">
                <div class="admins-cell"><div class="admin-name">${s.name || '—'}</div></div>
                <div class="admins-cell"><span class="status-badge pending">${typeLabel(s.type)}</span></div>
                <div class="admins-cell">${s.is_active ? '<span class="status-badge active">Ja</span>' : '<span class="status-badge expired">Nee</span>'}</div>
                <div class="admins-cell"><div class="date-info">${formatDate(lastEventByStream[s.id])}</div></div>
                <div class="admins-cell">${successRateByStream[s.id] != null ? successRateByStream[s.id] + '%' : '—'}</div>
                <div class="admins-cell actions-cell">
                  <div class="action-buttons">
                    <a href="/admin/opportunities/streams/${s.id}" class="btn-icon" title="Bekijken"><i class="fas fa-eye"></i></a>
                    <a href="/admin/opportunities/streams/${s.id}/edit" class="btn-icon" title="Bewerken"><i class="fas fa-edit"></i></a>
                    <button type="button" class="btn-icon copy-webhook-btn" data-stream-id="${s.id}" title="Kopieer webhook URL"><i class="fas fa-link"></i></button>
                    <button type="button" class="btn-icon rotate-secret-btn" data-stream-id="${s.id}" data-stream-name="${(s.name || '').replace(/"/g, '&quot;')}" title="Rotate secret"><i class="fas fa-key"></i></button>
                  </div>
                </div>
              </div>
            `).join('') }
            ${ (!streams || streams.length === 0) ? `
              <div class="admins-row"><div class="admins-cell empty-state">Nog geen kansenstromen. <a href="/admin/opportunities/streams/new">Maak er een aan</a>.</div></div>
            ` : '' }
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="secretModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: #fff; border-radius: 8px; padding: 20px; max-width: 480px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
      <h3 style="margin: 0 0 8px;">Nieuw secret</h3>
      <p class="text-muted" style="margin: 0 0 12px; font-size: 14px;">Bewaar dit secret; het wordt daarna niet meer getoond. Gebruik het als header <code>X-Stream-Secret</code> in Zapier of andere integraties.</p>
      <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 16px;">
        <input type="text" id="secretModalValue" readonly class="form-control" style="flex: 1; font-family: monospace;" />
        <button type="button" id="secretModalCopyBtn" class="btn-outline"><i class="fas fa-copy"></i> Kopieer</button>
      </div>
      <div style="display: flex; justify-content: flex-end;"><button type="button" id="secretModalCloseBtn" class="btn-primary">Sluiten</button></div>
    </div>
  </div>
  </div>
  `,
  scripts: typeof scripts !== 'undefined' ? scripts : ['/js/admin/opportunity-streams.js'],
  stylesheets: typeof stylesheets !== 'undefined' ? stylesheets : ['/css/opportunities.css', '/css/admin/opportunity-streams.css']
}) %>
