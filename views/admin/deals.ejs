<%
  const formatCurrency = (amount) => {
    if (amount == null) return '€0'
    return new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount)
  }
  const formatDate = (iso) => {
    if (!iso) return '—'
    return new Date(iso).toLocaleDateString('nl-NL', { day: '2-digit', month: 'short', year: 'numeric' })
  }
  const formatRelativeTime = (iso) => {
    if (!iso) return '-'
    const date = new Date(iso)
    if (Number.isNaN(date.getTime())) return '-'
    const now = new Date()
    const diffMs = now - date
    const diffMinutes = Math.round(diffMs / 60000)
    if (diffMinutes <= 0) return 'zojuist'
    if (diffMinutes < 60) return diffMinutes === 1 ? '1 minuut geleden' : `${diffMinutes} minuten geleden`
    const diffHours = Math.round(diffMinutes / 60)
    if (diffHours < 24) return diffHours === 1 ? '1 uur geleden' : `${diffHours} uur geleden`
    const diffDays = Math.round(diffHours / 24)
    if (diffDays < 7) return diffDays === 1 ? '1 dag geleden' : `${diffDays} dagen geleden`
    const diffWeeks = Math.round(diffDays / 7)
    if (diffWeeks < 5) return diffWeeks === 1 ? '1 week geleden' : `${diffWeeks} weken geleden`
    const diffMonths = Math.round(diffDays / 30)
    if (diffMonths < 12) return diffMonths === 1 ? '1 maand geleden' : `${diffMonths} maanden geleden`
    const diffYears = Math.round(diffDays / 365)
    return diffYears === 1 ? '1 jaar geleden' : `${diffYears} jaar geleden`
  }
  // Eenduidige deal-stages voor pipeline en data (list + Kanban)
  const DEAL_STAGES = [
    { key: 'discovery', label: 'Discovery' },
    { key: 'qualified', label: 'Gekwalificeerd' },
    { key: 'proposal', label: 'Offerte' },
    { key: 'negotiation', label: 'Onderhandeling' },
    { key: 'closed_won', label: 'Gewonnen' },
    { key: 'closed_lost', label: 'Verloren' }
  ]
  const stageLabels = DEAL_STAGES.reduce((acc, s) => { acc[s.key] = s.label; return acc }, {})
  const getStageLabel = (s) => stageLabels[s] || s || 'Offerte'
  const getStageClass = (s) => {
    if (s === 'closed_won' || s === 'won') return 'deal-stage-won'
    if (s === 'closed_lost' || s === 'lost') return 'deal-stage-lost'
    return 'deal-stage-open'
  }
  const getStatusClass = (s) => {
    if (s === 'won') return 'status-success'
    if (s === 'lost') return 'status-gray'
    return 'status-blue'
  }
  const getStatusLabel = (s) => (s === 'open' ? 'Open' : s === 'won' ? 'Gewonnen' : s === 'lost' ? 'Verloren' : s || 'Open')
  // Bepaal Kanban-kolom: won/lost gaan naar closed_*, anders stage (of proposal als default)
  const getKanbanStage = (d) => {
    if (d.status === 'won') return 'closed_won'
    if (d.status === 'lost') return 'closed_lost'
    const s = d.stage || 'proposal'
    return DEAL_STAGES.some(x => x.key === s) ? s : 'proposal'
  }
  const opp = (d) => d.opportunity || {}
  const renderDealCard = (d, forKanban = false) => {
    const title = d.title || opp(d).title || opp(d).company_name || 'Deal'
    const company = opp(d).company_name || ''
    const companyName = company || title || 'Onbekend bedrijf'
    const hasDistinctTitle = Boolean(company && title && title !== company)
    const initialsMatches = companyName ? companyName.match(/\b\w/g) : null
    const initials = (initialsMatches && initialsMatches.length ? initialsMatches.slice(0, 2).join('') : companyName.substring(0, 2)).toUpperCase()
    const repName = (typeof salesRepsMap !== 'undefined' && d.sales_rep_id && salesRepsMap[d.sales_rep_id]) ? salesRepsMap[d.sales_rep_id] : (d.sales_rep_id ? 'Rep' : '—')
    const valueDisplay = formatCurrency(d.value_eur)
    const stageLabel = getStageLabel(d.stage)
    const stageClass = getStageClass(d.stage)
    const statusClass = getStatusClass(d.status)
    const statusLabel = getStatusLabel(d.status)
    const contactItems = []
    if (opp(d).contact_name) contactItems.push(`<div class="opportunity-card-contact-item"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><span>${opp(d).contact_name}</span></div>`)
    if (opp(d).email) contactItems.push(`<div class="opportunity-card-contact-item"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg><span>${opp(d).email}</span></div>`)
    if (opp(d).phone) contactItems.push(`<div class="opportunity-card-contact-item"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg><span>${opp(d).phone}</span></div>`)
    const contactRow = contactItems.length ? `<div class="opportunity-card-contact">${contactItems.join('')}</div>` : ''
    const subtitleLine = hasDistinctTitle ? `<p class="opportunity-card-subtitle">${title}</p>` : (!company && title ? `<p class="opportunity-card-subtitle">${title}</p>` : '')
    const descriptionText = opp(d).description ? opp(d).description.trim() : ''
    const truncatedDescription = descriptionText.length > 160 ? `${descriptionText.substring(0, 160)}…` : descriptionText
    const descriptionLine = truncatedDescription ? `<p class="opportunity-card-description">${truncatedDescription}</p>` : ''
    const cardClasses = forKanban ? 'deal-kanban-card' : ''
    const cardInner = `
      <a href="/admin/opportunities/deals/${d.id}" class="opportunity-card-entry ${cardClasses}">
        <div class="opportunity-card">
          <div class="opportunity-card-main">
            <div class="opportunity-card-avatar deal-avatar">${initials}</div>
            <div class="opportunity-card-body">
              <div class="opportunity-card-header">
                <div class="opportunity-card-heading">
                  <div class="opportunity-card-heading-row">
                    <h3 class="opportunity-card-company">${companyName}</h3>
                    <span class="opportunity-badge ${statusClass}">${statusLabel}</span>
                    <span class="opportunity-badge ${stageClass}">${stageLabel}</span>
                    <span class="opportunity-badge status-gray">${repName}</span>
                  </div>
                  ${subtitleLine}
                  ${descriptionLine}
                  ${contactRow}
                </div>
                <div class="opportunity-card-meta">
                  <p class="opportunity-card-value">${valueDisplay}</p>
                  <p class="opportunity-card-time">${formatRelativeTime(d.updated_at || d.created_at)}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </a>
    `
    if (forKanban) {
      return `<div class="deal-kanban-card-wrapper" draggable="true" data-deal-id="${d.id}">${cardInner}</div>`
    }
    return cardInner
  }
  const baseUrl = '/admin/opportunities/deals'
  const dealsByStage = (deals || []).reduce((acc, d) => {
    const col = getKanbanStage(d)
    if (!acc[col]) acc[col] = []
    acc[col].push(d)
    return acc
  }, {})
%>
<%- include('../layouts/admin', {
  title: 'Deals',
  activeMenu: 'opportunities',
  activeSubmenu: 'deals',
  user: user,
  body: `
  <div class="opportunities-container">
    <div class="page-header">
      <div class="page-header-title">
        <h1>Deals</h1>
        <p class="page-header-subtitle">Pipeline met openstaande en afgesloten deals</p>
      </div>
    </div>

    <div class="kpi-cards-container deals-kpis">
      <div class="kpi-cards-grid">
        <div class="kpi-card">
          <div class="kpi-content">
            <p class="kpi-title">Totale waarde</p>
            <p class="kpi-value">${formatCurrency(kpis?.totalValue || 0)}</p>
            <p class="kpi-subtitle">Alle deals</p>
          </div>
          <div class="kpi-icon"><i class="fas fa-euro-sign"></i></div>
        </div>
        <div class="kpi-card">
          <div class="kpi-content">
            <p class="kpi-title">Open</p>
            <p class="kpi-value">${kpis?.openCount ?? 0}</p>
            <p class="kpi-subtitle">In pipeline</p>
          </div>
          <div class="kpi-icon"><i class="fas fa-folder-open"></i></div>
        </div>
        <div class="kpi-card">
          <div class="kpi-content">
            <p class="kpi-title">Gewonnen</p>
            <p class="kpi-value">${kpis?.wonCount ?? 0}</p>
            <p class="kpi-subtitle">Gesloten</p>
          </div>
          <div class="kpi-icon"><i class="fas fa-check-circle"></i></div>
        </div>
      </div>
    </div>

    <div class="opportunities-listing-container">
      <div class="opportunities-header-row">
        <div class="deals-filter-tabs">
          <a href="${baseUrl}${viewMode === 'kanban' ? '?view=kanban' : ''}" class="deals-tab ${filterStatus === 'all' ? 'active' : ''}">Alle</a>
          <a href="${baseUrl}?status=open${viewMode === 'kanban' ? '&view=kanban' : ''}" class="deals-tab ${filterStatus === 'open' ? 'active' : ''}">Open</a>
          <a href="${baseUrl}?status=won${viewMode === 'kanban' ? '&view=kanban' : ''}" class="deals-tab ${filterStatus === 'won' ? 'active' : ''}">Gewonnen</a>
          <a href="${baseUrl}?status=lost${viewMode === 'kanban' ? '&view=kanban' : ''}" class="deals-tab ${filterStatus === 'lost' ? 'active' : ''}">Verloren</a>
        </div>
        <div class="deals-view-toggle">
          <a href="${baseUrl}${filterStatus && filterStatus !== 'all' ? '?status=' + filterStatus : ''}" class="deals-view-btn ${viewMode !== 'kanban' ? 'active' : ''}" title="Lijstweergave"><i class="fas fa-list" aria-hidden="true"></i><span>Lijst</span></a>
          <a href="${baseUrl}?${filterStatus && filterStatus !== 'all' ? 'status=' + filterStatus + '&' : ''}view=kanban" class="deals-view-btn ${viewMode === 'kanban' ? 'active' : ''}" title="Kanban"><i class="fas fa-columns" aria-hidden="true"></i><span>Kanban</span></a>
        </div>
      </div>
      ${viewMode === 'kanban' ? `
      <div class="deals-kanban" id="dealsKanban">
        ${DEAL_STAGES.map(stage => {
          const colDeals = dealsByStage[stage.key] || []
          return `
          <div class="deals-kanban-column" data-stage="${stage.key}">
            <div class="deals-kanban-column-header">
              <span class="deals-kanban-column-title">${stage.label}</span>
              <span class="deals-kanban-column-count">${colDeals.length}</span>
            </div>
            <div class="deals-kanban-column-cards">
              ${colDeals.map(d => renderDealCard(d, true)).join('')}
            </div>
          </div>
          `
        }).join('')}
      </div>
      ` : `
      <div class="opportunities-list" id="dealsList">
        ${(deals || []).map(d => renderDealCard(d, false)).join('')}
        ${(!deals || deals.length === 0) ? `
          <div class="deals-empty">
            <div class="deals-empty-icon"><i class="fas fa-handshake"></i></div>
            <p class="deals-empty-title">Nog geen deals</p>
            <p class="deals-empty-text">Deals ontstaan wanneer je een kans omzet naar een deal op de kansdetailpagina.</p>
            <a href="/admin/opportunities" class="btn btn-primary">Naar kansen</a>
          </div>
        ` : ''}
      </div>
      `}
    </div>
  </div>
  `,
  scripts: (scripts || ['/js/admin/deals.js']),
  stylesheets: (stylesheets || [])
}) %>
