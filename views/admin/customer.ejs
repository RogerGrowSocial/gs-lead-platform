<%
  // Get customer data from customerData (passed from route)
  var customer = typeof customerData !== 'undefined' ? customerData : {}
  
  var formatCurrency = function(amount) {
    if (!amount) return 'â‚¬0'
    return new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0 }).format(amount)
  }
  
  var formatDate = function(iso) {
    if (!iso) return '-'
    var d = new Date(iso)
    return d.toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' })
  }

  var formatDateTime = function(iso) {
    if (!iso) return '-'
    var d = new Date(iso)
    var options = { 
      day: 'numeric', 
      month: 'long', 
      year: 'numeric', 
      hour: '2-digit', 
      minute: '2-digit' 
    }
    return d.toLocaleString('nl-NL', options)
  }

  var formatRelativeTime = function(iso) {
    if (!iso) return 'Nog nooit'
    var d = new Date(iso)
    var now = new Date()
    var diffMs = now - d
    var diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))
    if (diffDays === 0) return 'Vandaag'
    if (diffDays === 1) return 'Gisteren'
    if (diffDays < 7) return diffDays + ' dagen geleden'
    if (diffDays < 30) {
      var weeks = Math.floor(diffDays / 7)
      return weeks === 1 ? '1 week geleden' : weeks + ' weken geleden'
    }
    return d.toLocaleDateString('nl-NL', { day: '2-digit', month: 'short', year: 'numeric' })
  }

  var status = customer.status || 'active'
  var priority = customer.priority || 'normal'
  
  // Get initials for avatar
  var initials = ''
  if (customer.name && customer.name.length > 0) {
    var nameParts = customer.name.split(' ')
    if (nameParts.length > 0) {
      initials = nameParts[0].charAt(0).toUpperCase()
      if (nameParts.length > 1) {
        initials += nameParts[nameParts.length - 1].charAt(0).toUpperCase()
      }
    }
  } else if (customer.company_name && customer.company_name.length > 0) {
    initials = customer.company_name.charAt(0).toUpperCase()
  } else if (customer.email && customer.email.length > 0) {
    initials = customer.email.charAt(0).toUpperCase()
  } else {
    initials = 'K'
  }

  // Get customer name for display
  var customerName = customer.name || customer.company_name || 'Klant'
  
  // Status labels and colors
  var statusLabels = {
    'active': 'Actief',
    'inactive': 'Inactief',
    'lead': 'Lead',
    'prospect': 'Prospect'
  }
  
  var statusStyles = {
    'active': 'status-paid',
    'inactive': 'status-cancelled',
    'lead': 'status-pending',
    'prospect': 'status-pending'
  }
  
  var priorityLabels = {
    'low': 'Laag',
    'normal': 'Normaal',
    'high': 'Hoog',
    'vip': 'VIP'
  }
  
  var priorityColors = {
    'low': '#6b7280',
    'normal': '#3b82f6',
    'high': '#f59e0b',
    'vip': '#f59e0b'
  }

  // Contact info
  var hasEmail = !!(customer.email && customer.email.trim())
  var hasPhone = !!(customer.phone && customer.phone.trim())
  var hasLocation = !!(customer.city || customer.postal_code || customer.address)
  var location = ''
  if (customer.address) location += customer.address
  if (customer.postal_code) location += (location ? ', ' : '') + customer.postal_code
  if (customer.city) location += (location ? ' ' : '') + customer.city

  // Stats
  var stats = customer.stats || { total_tickets: 0, open_tickets: 0, total_emails: 0, unread_emails: 0 }
  var tickets = customer.tickets || []
  var emails = customer.emails || []
  var customerEmails = customer.customerEmails || []
  var activities = customer.activities || []
  var userAccount = customer.userAccount || null
  var tasks = customer.tasks || []
  var timeEntries = customer.timeEntries || []
  var timeTotalsByEmployee = customer.timeTotalsByEmployee || {}

  // Prepare include options
  var pageTitle = customerName + ' - Klanten | GrowSocial Admin'
%>
<%- include('../layouts/admin', {
  title: pageTitle,
  activeMenu: 'customers',
  user: user,
  showBackButton: true,
  backButtonUrl: '/admin/customers',
  backButtonText: 'Terug naar klanten',
  body: (function() {
    var output = '';
    output += `
  <div class="user-detail-page">
    <!-- Main Content Grid -->
    <div class="user-detail-grid-new">
      <!-- Left Column (2/3 width) -->
      <div class="user-detail-main-new">
        <!-- Customer Info Card -->
        <div class="user-card user-info-card-new">
          <div class="user-card-content">
            <div class="user-info-avatar-section">
              <div id="customerAvatarTrigger" style="cursor: pointer; position: relative; display: inline-block;">
                <span class="user-avatar-large-new" id="customerAvatar" aria-hidden="true" style="${customer.logo_url ? 'box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);' : ''}">
                  ${customer.logo_url ? `<img src="${customer.logo_url}" alt="${customerName}" loading="eager" decoding="async" width="120" height="120" style="width: 100%; height: 100%; object-fit: contain; border-radius: 50%; background: white;" onerror="this.style.display='none'; this.parentElement.querySelector('div').style.display='flex';" />` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;background:linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);color:#6b7280;border-radius:50%;border:2px solid #e5e7eb;"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.6;"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>`}
                </span>
              </div>
              <input type="file" id="customerLogoUpload" accept="image/*" style="display: none;" />
              <div class="user-info-name-section" style="flex: 1;">
                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                  <h1 class="user-info-name-new" id="customerNameDisplay" style="flex: 1; margin: 0;">${customerName}</h1>
                  ${(typeof canEditCustomer !== 'undefined' && canEditCustomer ? '<button type="button" id="editCustomerBtn" class="edit-customer-btn" style="background: none; border: none; cursor: pointer; padding: 4px; color: #9ca3af; transition: color 0.2s; margin-left: auto;" onmouseover="this.style.color=\'#6b7280\'" onmouseout="this.style.color=\'#9ca3af\'"><i class="fas fa-pencil-alt" style="font-size: 18px;"></i></button>' : '')}
                </div>
                <div class="user-info-badges-container" id="badgesContainer">
                  ${(userAccount ? '<span class="user-role-badge-new is-user"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>Heeft account</span>' : '')}
                </div>
              </div>
            </div>
            ${(customer.company_name ? '<div class="user-info-company-section"><div class="user-info-company-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building2"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"></path><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"></path><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"></path><path d="M10 6h4"></path><path d="M10 10h4"></path><path d="M10 14h4"></path><path d="M10 18h4"></path></svg></div><span class="user-info-company-name">' + customer.company_name + '</span></div><div class="user-info-company-divider"></div>' : '')}
            <div class="user-info-contact-section">
              ${(hasEmail ? '<div class="user-info-contact-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail"><rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg><a href="mailto:' + customer.email + '" class="user-info-contact-text" data-field="email" data-edit-type="text" style="text-decoration: none; color: inherit;">' + customer.email + '</a></div>' : '')}
              ${(hasPhone ? '<div class="user-info-contact-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-phone"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg><a href="tel:' + customer.phone + '" class="user-info-contact-text" data-field="phone" data-edit-type="text" style="text-decoration: none; color: inherit;">' + customer.phone + '</a></div>' : '')}
              ${(hasLocation ? '<div class="user-info-contact-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin"><path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"></path><circle cx="12" cy="10" r="3"></circle></svg><a href="https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(location) + '" target="_blank" rel="noopener noreferrer" class="user-info-contact-text" data-field="address" data-edit-type="text" style="text-decoration: none; color: inherit;">' + location + '</a></div>' : '')}
              ${customer.domain ? `<div class="user-info-contact-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-globe"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg><a href="${customer.website && customer.website.startsWith('http') ? customer.website : customer.domain.startsWith('http') ? customer.domain : 'https://' + (customer.website || customer.domain)}" target="_blank" rel="noopener noreferrer" class="user-info-contact-text" data-field="domain" data-edit-type="text" style="text-decoration: none; color: inherit;">${customer.domain}</a></div>` : ''}
            </div>
          </div>
        </div>

        <!-- KPI Cards - Always Visible -->
        <div class="kpi-cards-container">
          <div class="kpi-cards-grid">
            <!-- Open Taken Card -->
            <div class="kpi-card">
              <div class="kpi-content">
                <p class="kpi-title">Open taken</p>
                <p class="kpi-value">${(stats.open_tasks || 0)}</p>
              </div>
              <div class="kpi-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list">
                  <rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect>
                  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                  <path d="M12 11h4"></path>
                  <path d="M12 16h4"></path>
                  <path d="M8 11h.01"></path>
                  <path d="M8 16h.01"></path>
                </svg>
              </div>
            </div>
            
            <!-- Open Tickets Card -->
            <div class="kpi-card">
              <div class="kpi-content">
                <p class="kpi-title">Open tickets</p>
                <p class="kpi-value">${(stats.open_tickets || 0)}</p>
              </div>
              <div class="kpi-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ticket">
                  <path d="M2 5a2 2 0 0 1 2-2h.5a2 2 0 0 0 2-2h1a2 2 0 0 0 2 2h.5a2 2 0 0 1 2 2v1a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-.5a2 2 0 0 1 2-2h.5a2 2 0 0 1 2 2v.5a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-1a2 2 0 0 1 2-2h.5a2 2 0 0 1 2 2v.5a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-1a2 2 0 0 1 2-2h.5a2 2 0 0 1 2 2V19a2 2 0 0 1-2 2h-16a2 2 0 0 1-2-2V5Z"></path>
                  <path d="M2 9h20"></path>
                  <path d="M2 15h20"></path>
                </svg>
              </div>
            </div>
            
            <!-- Openstaand Card -->
            <div class="kpi-card">
              <div class="kpi-content">
                <p class="kpi-title">Openstaand</p>
                <p class="kpi-value">${formatCurrency(stats.total_outstanding || 0)}</p>
              </div>
              <div class="kpi-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-alert">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" x2="12" y1="8" y2="12"></line>
                  <line x1="12" x2="12.01" y1="16" y2="16"></line>
                </svg>
              </div>
            </div>
            
            <!-- Totaal Card -->
            <div class="kpi-card">
              <div class="kpi-content">
                <p class="kpi-title">Totaal</p>
                <p class="kpi-value">${formatCurrency(stats.total_revenue || 0)}</p>
              </div>
              <div class="kpi-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-up">
                  <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
                  <polyline points="16 7 22 7 22 13"></polyline>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="customer-main-tabs-container">
          <div class="customer-main-tabs-header">
            <button class="customer-main-tab-btn customer-main-tab-active" data-main-tab="overview">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="18" height="18" x="3" y="3" rx="2"></rect>
                <path d="M3 9h18"></path>
                <path d="M9 21V9"></path>
              </svg>
              Overzicht
            </button>
            <button class="customer-main-tab-btn" data-main-tab="tasks">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect>
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                <path d="M12 11h4"></path>
                <path d="M12 16h4"></path>
                <path d="M8 11h.01"></path>
                <path d="M8 16h.01"></path>
              </svg>
              Taken
            </button>
            <button class="customer-main-tab-btn" data-main-tab="administration">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              Administratie
            </button>
            <button class="customer-main-tab-btn" data-main-tab="communication">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 1 1 8.5-8.5M22 12.5a10 10 0 1 1-8.5 8.5"></path>
              </svg>
              Communicatie
            </button>
          </div>

          <!-- Overview Tab Content -->
          <div class="customer-main-tab-content customer-main-tab-content-active" id="main-tab-overview">
            <!-- Overview content can be added here if needed -->
          </div>

          <!-- Tasks Tab Content -->
          <div class="customer-main-tab-content" id="main-tab-tasks" style="display: none;">
            <div class="user-card">
              <div class="user-card-content">
                <div class="user-card-header-with-action">
                  <h3 class="user-card-title-small">Taken</h3>
                  <a href="/admin/tasks?customer_id=${customer.id}" class="btn-primary" style="padding: 8px 16px; font-size: 14px; text-decoration: none;">
                    <i class="fas fa-plus"></i> Nieuwe Taak
                  </a>
                </div>
                ${(tasks.length > 0 ? '<div class="user-activity-list">' + tasks.map(function(task) {
                      var taskStatus = task.status || 'open'
                      var taskPriority = task.priority || 'medium'
                      var statusColors = {
                        'open': '#3b82f6',
                        'in_progress': '#f59e0b',
                        'in_review': '#8b5cf6',
                        'done': '#10b981',
                        'rejected': '#ef4444'
                      }
                      var statusLabels = {
                        'open': 'Open',
                        'in_progress': 'In Uitvoering',
                        'in_review': 'In Review',
                        'done': 'Afgerond',
                        'rejected': 'Afgewezen'
                      }
                      var statusColor = statusColors[taskStatus] || '#6b7280'
                      var priorityColor = priorityColors[taskPriority] || '#6b7280'
                      var employeeName = task.employee ? (task.employee.first_name && task.employee.last_name ? task.employee.first_name + ' ' + task.employee.last_name : task.employee.email) : 'Niet toegewezen'
                      
                      var employeeHtml = task.employee ? '<span style="font-size: 11px; color: #6b7280;"><i class="fas fa-user" style="margin-right: 4px;"></i><a href="/admin/employees/' + task.employee.id + '" style="color: #3b82f6; text-decoration: none;" onclick="event.stopPropagation();">' + employeeName + '</a></span>' : ''
                      var dueHtml = task.due_at ? '<span style="font-size: 11px; color: #6b7280;"><i class="fas fa-calendar" style="margin-right: 4px;"></i>' + formatDate(task.due_at) + '</span>' : ''
                      var valueHtml = task.value_cents > 0 ? '<span style="font-size: 11px; color: #6b7280;"><i class="fas fa-euro-sign" style="margin-right: 4px;"></i>' + formatCurrency(task.value_cents) + '</span>' : ''
                      return '<div class="user-activity-item" style="cursor: pointer;" onclick="window.location.href=\'/admin/tasks/' + task.id + '\'"><div class="user-activity-icon" style="background-color: ' + statusColor + '20;"><i class="fas fa-tasks" style="color: ' + statusColor + ';"></i></div><div class="user-activity-content" style="flex: 1;"><p class="user-activity-title">' + (task.title || 'Geen titel') + '</p><div style="display: flex; gap: 12px; align-items: center; margin-top: 4px; flex-wrap: wrap;"><span class="status-badge" style="background-color: ' + statusColor + '20; color: ' + statusColor + '; font-size: 11px; padding: 2px 8px;">' + (statusLabels[taskStatus] || taskStatus) + '</span><span class="status-badge" style="background-color: ' + priorityColor + '20; color: ' + priorityColor + '; font-size: 11px; padding: 2px 8px;">' + (priorityLabels[taskPriority] || taskPriority) + '</span>' + employeeHtml + dueHtml + valueHtml + '</div></div></div>'
                    }).join('') + '</div><a href="/admin/tasks?customer_id=' + customer.id + '" class="user-activity-view-all">Bekijk alle taken ></a>' : '<div style="text-align: center; padding: 3rem 1rem;"><p class="user-empty-text" style="margin-bottom: 1.5rem;">Geen taken gevonden.</p><a href="/admin/tasks?customer_id=' + customer.id + '" class="btn-primary" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 10px 20px; font-size: 14px; text-decoration: none; border-radius: 8px;"><i class="fas fa-plus"></i> Eerste taak aanmaken</a></div>')}
              </div>
            </div>
          </div>

          <!-- Administration Tab Content -->
          <div class="customer-main-tab-content" id="main-tab-administration" style="display: none;">
            <div class="user-card">
              <div class="user-card-content">
                <div class="user-card-header-with-action">
                  <h3 class="user-card-title-small">Facturen</h3>
                  <div style="display: flex; gap: 8px;">
                    <label for="invoiceImportFile" class="btn-primary" style="padding: 8px 16px; font-size: 14px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; border: none;">
                      <i class="fas fa-upload"></i> Importeer CSV
                    </label>
                    <input type="file" id="invoiceImportFile" accept=".csv" style="display: none;" />
                    <a href="/admin/customers/${customer.id}/invoices/new" class="btn-primary" style="padding: 8px 16px; font-size: 14px; border: none; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                      <i class="fas fa-plus"></i> Nieuwe Factuur
                    </a>
                  </div>
                </div>
                <div id="invoicesTableContainer">
                  <!-- Invoices table will be rendered here by JavaScript -->
                </div>
              </div>
            </div>
          </div>

          <!-- Communication Tab Content -->
          <div class="customer-main-tab-content" id="main-tab-communication" style="display: none;">
            <div class="user-card">
              <div class="user-card-content">
                <div class="user-card-header-with-action">
                  <h3 class="user-card-title-small">E-mails</h3>
                  <a href="/admin/mail?customer_id=${customer.id}" class="btn-primary" style="padding: 8px 16px; font-size: 14px; text-decoration: none;">
                    <i class="fas fa-envelope"></i> Bekijk alle e-mails
                  </a>
                </div>
                ${(emails.length > 0 ? '<div class="user-activity-list">' + emails.map(function(email) {
                      var isUnread = !email.read_at
                      var unreadBg = isUnread ? '#3b82f620' : '#6b728020'
                      var unreadColor = isUnread ? '#3b82f6' : '#6b7280'
                      var unreadWeight = isUnread ? '600' : '400'
                      var unreadBadge = isUnread ? '<span style="color: #3b82f6; margin-left: 8px; font-size: 10px;">(Ongelezen)</span>' : ''
                      return '<div class="user-activity-item" style="cursor: pointer;" onclick="window.location.href=\'/admin/mail/' + email.id + '\'"><div class="user-activity-icon" style="background-color: ' + unreadBg + ';"><i class="fas fa-envelope" style="color: ' + unreadColor + ';"></i></div><div class="user-activity-content" style="flex: 1;"><p class="user-activity-title" style="font-weight: ' + unreadWeight + ';">' + (email.subject || 'Geen onderwerp') + unreadBadge + '</p><p class="user-activity-date">' + formatDateTime(email.created_at) + '</p></div></div>'
                    }).join('') + '</div><a href="/admin/mail?customer_id=' + customer.id + '" class="user-activity-view-all">Bekijk alle e-mails ></a>' : '<div style="text-align: center; padding: 3rem 1rem;"><p class="user-empty-text">Geen e-mails gevonden.</p></div>')}
              </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="user-card" style="margin-top: 1.5rem;">
              <div class="user-card-content">
                <h3 class="user-card-title-small" style="margin-bottom: 1rem;">Snelle acties</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                  <button type="button" class="btn-primary" onclick="window.location.href='/admin/mail?customer_id=${customer.id}&action=compose'" style="padding: 12px 16px; font-size: 14px; text-align: left; display: flex; align-items: center; gap: 12px; border: none; cursor: pointer; border-radius: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M22 2 11 13"></path>
                      <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
                    </svg>
                    E-mail sturen
                  </button>
                  <button type="button" class="btn-primary" onclick="alert('Meeting plannen functionaliteit komt binnenkort')" style="padding: 12px 16px; font-size: 14px; text-align: left; display: flex; align-items: center; gap: 12px; border: none; cursor: pointer; border-radius: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Meeting plannen
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Right Sidebar (1/3 width) -->
      <div class="user-detail-sidebar-new">
        <!-- AI Summary Card -->
        <div class="user-card" style="margin-bottom: 1rem;">
          <div class="user-card-content">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
              <h3 class="user-card-title-small" style="display: flex; align-items: center; gap: 8px; margin: 0;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9333ea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path>
                  <path d="M20 3v4"></path>
                  <path d="M22 5h-4"></path>
                  <path d="M4 17v2"></path>
                  <path d="M5 18H3"></path>
                </svg>
                AI Samenvatting
              </h3>
              <button type="button" id="refreshCustomerAiSummaryBtn" style="background: none; border: none; cursor: pointer; padding: 6px 10px; color: #6b7280; font-size: 13px; display: flex; align-items: center; gap: 6px; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'; this.style.color='#374151';" onmouseout="this.style.background='none'; this.style.color='#6b7280';">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.7 2.7L21 8"></path>
                  <path d="M21 3v5h-5"></path>
                </svg>
                Hergenereer
              </button>
            </div>
            <div id="customerAiSummaryBox" style="margin-bottom: 20px;">
              <div id="customerAiSummaryText" style="white-space: pre-line; font-size: 14px; color: #111827; line-height: 1.6; min-height: 60px;">
                ${(customer.aiSummary && customer.aiSummary.summary ? customer.aiSummary.summary : 'AI samenvatting wordt gegenereerd...')}
              </div>
              <div id="customerAiSummaryLoading" style="display: none; text-align: center; padding: 20px; color: #6b7280; font-size: 14px;">
                <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                AI samenvatting wordt gegenereerd...
              </div>
            </div>
            
            <!-- AI Chat Interface -->
            <div style="border-top: 1px solid #e5e7eb; padding-top: 16px; margin-top: 16px;">
              <form id="customerAiChatForm" style="display: flex; gap: 8px;">
                <input 
                  type="text" 
                  id="customerAiChatInput" 
                  placeholder="Stel een vraag over deze klant..." 
                  style="flex: 1; padding: 10px 14px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none; transition: all 0.2s;"
                  onfocus="this.style.borderColor='#9333ea'; this.style.boxShadow='0 0 0 3px rgba(147, 51, 234, 0.1)';"
                  onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';"
                />
                <button 
                  type="submit" 
                  id="customerAiChatSubmit"
                  style="padding: 10px 16px; background: #9333ea; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;"
                  onmouseover="this.style.background='#7e22ce';"
                  onmouseout="this.style.background='#9333ea';"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m22 2-7 20-4-9-9-4Z"></path>
                    <path d="M22 2 11 13"></path>
                  </svg>
                  Verzend
                </button>
              </form>
              <div id="customerAiChatResponse" style="margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 14px; color: #374151; line-height: 1.6; min-height: 40px; display: none; white-space: pre-line;"></div>
            </div>
          </div>
        </div>

        <!-- Account Info Card -->
        <div class="user-card" style="margin-bottom: 1rem;">
          <div class="user-card-content">
            <h3 class="user-card-title-small" style="margin-bottom: 1rem;">Klant Informatie</h3>
            
            <div class="user-info-list">
              <!-- Status & Priority -->
              <div class="user-info-item">
                <p class="user-info-label">Status</p>
                <p class="user-info-value">
                  <span class="status-badge" id="statusBadge" data-field="status" data-edit-type="select" data-options='${JSON.stringify(Object.keys(statusLabels))}' style="background-color: ${(status === 'active' ? '#10b98120' : '#6b728020')}; color: ${(status === 'active' ? '#10b981' : '#6b7280')}; font-size: 0.8125rem; padding: 4px 8px; border-radius: 4px;">
                    ${(statusLabels[status] || status)}
                  </span>
                </p>
              </div>
              <div class="user-info-item">
                <p class="user-info-label">Prioriteit</p>
                <p class="user-info-value">
                  <span class="status-badge" id="priorityBadge" data-field="priority" data-edit-type="select" data-options='${JSON.stringify(Object.keys(priorityLabels))}' style="background-color: ${(priority === 'high' ? '#ef444420' : priority === 'urgent' ? '#dc262620' : priority === 'low' ? '#6b728020' : '#3b82f620')}; color: ${(priority === 'high' ? '#ef4444' : priority === 'urgent' ? '#dc2626' : priority === 'low' ? '#6b7280' : '#3b82f6')}; font-size: 0.8125rem; padding: 4px 8px; border-radius: 4px;">
                    ${(priorityLabels[priority] || priority)}
                  </span>
                </p>
              </div>
              ${(customer.status === 'inactive' ? '<div class="user-info-item"><p class="user-info-label">Klant van</p><p class="user-info-value" data-field="inactive_from" data-edit-type="date" data-restricted="true">' + (customer.inactive_from ? formatDate(customer.inactive_from) : formatDate(customer.created_at)) + '</p></div><div class="user-info-item"><p class="user-info-label">Klant tot</p><p class="user-info-value" data-field="inactive_to" data-edit-type="date" data-restricted="true">' + (customer.inactive_to ? formatDate(customer.inactive_to) : 'Heden') + '</p></div><div class="user-info-item"><p class="user-info-label">Reden inactiviteit</p><p class="user-info-value" data-field="inactive_reason" data-edit-type="select" data-restricted="true" data-options=\'' + JSON.stringify(['temporary_pause', 'too_expensive', 'insufficient_results', 'not_matching_customer', 'no_capacity', 'switch', 'conflict', 'non_payment', 'other']) + '\'>' + (customer.inactive_reason ? (customer.inactive_reason === 'temporary_pause' ? 'Tijdelijke pauze' : customer.inactive_reason === 'too_expensive' ? 'Te duur / budget' : customer.inactive_reason === 'insufficient_results' ? 'Onvoldoende resultaat' : customer.inactive_reason === 'not_matching_customer' ? 'Niet passende klant' : customer.inactive_reason === 'no_capacity' ? 'Geen capaciteit bij klant' : customer.inactive_reason === 'switch' ? 'Overstap' : customer.inactive_reason === 'conflict' ? 'Conflict' : customer.inactive_reason === 'non_payment' ? 'Wanbetaling' : customer.inactive_reason === 'other' ? 'Anders (toelichten)' : customer.inactive_reason) : '-') + '</p></div>' + (customer.inactive_reason === 'other' ? '<div class="user-info-item" id="inactive-reason-other-item"><p class="user-info-label">Toelichting</p><p class="user-info-value" data-field="inactive_reason_other" data-edit-type="text" data-restricted="true">' + (customer.inactive_reason_other || '') + '</p></div>' : '') : '<div class="user-info-item"><p class="user-info-label">Klant sinds</p><p class="user-info-value" data-field="created_at" data-edit-type="date" data-restricted="true">' + formatDateTime(customer.created_at) + '</p></div>')}
              
              <div class="user-info-item">
                <p class="user-info-label">Laatste update</p>
                <p class="user-info-value">
                  ${(customer.updated_at ? formatDateTime(customer.updated_at) : 'Nog niet bijgewerkt')}
                </p>
              </div>
              
              <div class="user-info-item">
                <p class="user-info-label">Laatste activiteit</p>
                <p class="user-info-value">
                  ${(customer.last_ticket_activity || customer.last_email_activity ? formatRelativeTime(customer.last_ticket_activity || customer.last_email_activity) : 'Geen activiteit')}
                </p>
              </div>
              
              <div class="user-info-item">
                <p class="user-info-label">Klant ID</p>
                <p class="user-info-value user-info-mono">${(customer.id ? customer.id.substring(0, 8) : '-')}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- User Account Card (if exists) -->
        ${(userAccount ? '<div class="user-card" style="margin-bottom: 1rem;"><div class="user-card-content"><h3 class="user-card-title-small" style="margin-bottom: 1rem;">Gekoppeld Account</h3><div class="user-info-list"><div class="user-info-item"><p class="user-info-label">Account ID</p><p class="user-info-value user-info-mono">' + (userAccount.id ? userAccount.id.substring(0, 8) : '-') + '</p></div><div class="user-info-item"><p class="user-info-label">Status</p><p class="user-info-value">' + (userAccount.status || 'active') + '</p></div><div class="user-info-item"><p class="user-info-label">Laatste login</p><p class="user-info-value">' + (userAccount.last_login ? formatRelativeTime(userAccount.last_login) : 'Nog niet ingelogd') + '</p></div></div><a href="/admin/users/' + userAccount.id + '" class="btn-primary" style="display: block; text-align: center; margin-top: 16px; padding: 8px 16px; font-size: 14px; text-decoration: none;">Bekijk account ></a></div></div>' : '')}


        <!-- Team Card -->
        <div class="user-card" style="margin-bottom: 1rem;">
          <div class="user-card-content">
            <div class="user-card-header-with-action">
              <h3 class="user-card-title-small">Team</h3>
              <button type="button" class="btn-primary" id="addEmployeeBtn" style="padding: 8px 16px; font-size: 14px; border: none; cursor: pointer; border-radius: 8px;">
                <i class="fas fa-plus"></i> Werknemer toevoegen
              </button>
            </div>
            <div id="responsibleEmployeesList">
              ${((typeof customerData !== 'undefined' && customerData.responsibleEmployees && customerData.responsibleEmployees.length > 0) ? '<div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 1rem;">' + customerData.responsibleEmployees.map(function(assignment) {
                    var employee = assignment.employee || {}
                    var firstName = employee.first_name || ''
                    var lastName = employee.last_name || ''
                    var employeeName = firstName && lastName 
                      ? firstName + ' ' + lastName 
                      : firstName || employee.email || 'Onbekend'
                    var profilePicture = employee.profile_picture || null
                    var roleName = employee.role_name || 'Werknemer'
                    
                    // Get initials for avatar fallback
                    var initials = ''
                    if (firstName) {
                      initials = firstName.charAt(0).toUpperCase()
                      if (lastName) {
                        initials += lastName.charAt(0).toUpperCase()
                      }
                    } else if (employee.email) {
                      initials = employee.email.charAt(0).toUpperCase()
                    } else {
                      initials = '?'
                    }
                    
                    var imgHtml = profilePicture 
                      ? '<img src="' + profilePicture + '" alt="' + employeeName + '" style="width: 100%; height: 100%; object-fit: cover;" />'
                      : '<span style="font-size: 28px; font-weight: 600; color: #6b7280;">' + initials + '</span>'
                    var removeBtnHtml = (typeof canEditCustomer !== 'undefined' && canEditCustomer)
                      ? '<button type="button" class="remove-employee-btn" data-employee-id="' + employee.id + '" style="position: absolute; top: -4px; right: -4px; width: 24px; height: 24px; background: #ef4444; color: white; border: 2px solid white; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background=\'#dc2626\'; this.style.transform=\'scale(1.1)\'" onmouseout="this.style.background=\'#ef4444\'; this.style.transform=\'scale(1)\'" onclick="event.stopPropagation();"><i class="fas fa-times"></i></button>'
                      : ''
                    return '<div class="team-member-card" data-assignment-id="' + assignment.id + '" data-employee-id="' + employee.id + '" style="display: flex; flex-direction: column; align-items: center; gap: 8px; position: relative; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.transform=\'translateY(0)\'" onclick="window.location.href=\'/admin/employees/' + employee.id + '\'"><div style="position: relative; width: 80px; height: 80px; border-radius: 50%; overflow: hidden; border: 3px solid #e5e7eb; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.borderColor=\'#d1d5db\'; this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.1)\'" onmouseout="this.style.borderColor=\'#e5e7eb\'; this.style.boxShadow=\'none\'">' + imgHtml + '</div><div style="text-align: center;"><p style="margin: 0; font-size: 0.875rem; font-weight: 500; color: #111827; line-height: 1.4;">' + (firstName || employeeName) + '</p><p style="margin: 4px 0 0 0; font-size: 0.75rem; color: #6b7280; line-height: 1.4;">' + roleName + '</p></div>' + removeBtnHtml + '</div>'
                  }).join('') + '</div>' : '<div style="text-align: center; padding: 2rem 1rem;"><p class="user-empty-text" style="margin-bottom: 1rem;">Geen werknemers toegewezen.</p><button type="button" class="btn-primary" id="addEmployeeBtnEmpty" style="padding: 10px 20px; font-size: 14px; border: none; cursor: pointer; border-radius: 8px;"><i class="fas fa-plus"></i> Eerste werknemer toevoegen</button></div>')}
            </div>
          </div>
        </div>

        <!-- Contract Card -->
        <div class="user-card">
          <div class="user-card-content">
            <h3 class="user-card-title-small" style="margin-bottom: 0.75rem;">
              <i class="fas fa-file-contract"></i> Overeenkomst
            </h3>
            <div id="contractDisplay">
              ${(customer.contract_document_url ? '<div style="position: relative; padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; min-height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center;">' + (typeof canEditCustomer !== 'undefined' && canEditCustomer ? '<button onclick="showContractMenu(event)" class="contract-menu-btn" style="position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; color: #6b7280; cursor: pointer; padding: 0.5rem; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 10;" onmouseover="this.style.background=\'#f3f4f6\'; this.style.color=\'#374151\';" onmouseout="this.style.background=\'none\'; this.style.color=\'#6b7280\';"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></button>' : '') + '<div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem; width: 100%;"><svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #6b7280;"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg><p id="contractFileName" style="margin: 0; font-size: 0.8125rem; color: #374151; font-weight: 500; text-align: center; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + (customer.contract_document_name || (customer.contract_document_url.split('/').pop() || 'contract')) + '">' + (customer.contract_document_name ? (customer.contract_document_name.length > 25 ? customer.contract_document_name.substring(0, 22) + '...' : customer.contract_document_name) : (customer.contract_document_url.split('/').pop() || 'contract')) + '</p></div></div>' : (typeof canEditCustomer !== 'undefined' && canEditCustomer ? '<label for="contractUpload" style="display: block; cursor: pointer;"><div id="contractUploadArea" class="contract-drop-zone" style="padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; min-height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s;" onmouseover="this.style.background=\'#f3f4f6\'; this.style.borderColor=\'#d1d5db\';" onmouseout="this.style.background=\'#f9fafb\'; this.style.borderColor=\'#e5e7eb\';"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #9ca3af; transition: all 0.2s;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><p style="margin: 0; font-size: 0.8125rem; color: #6b7280; font-weight: 500; transition: all 0.2s;">Upload bestand</p></div></label><input type="file" id="contractUpload" accept=".pdf,.doc,.docx" style="display: none;" onchange="handleContractUpload(event)">' : '<div style="padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; min-height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem;"><p style="margin: 0; font-size: 0.8125rem; color: #6b7280;">Nog geen overeenkomst</p></div>'))}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Customer Logo Modal -->
  <div id="customerLogoModal" class="modal" style="display: none; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);">
    <div class="modal-content modal-sm" style="max-width: 520px; width: 90%; padding: 0; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
      <div class="modal-header" style="padding: 20px 24px; border-bottom: 1px solid #e5e7eb;">
        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #111827;">Bedrijfslogo</h3>
        <button class="modal-close" aria-label="Sluiten" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 5px; line-height: 1; transition: color 0.2s;" onmouseover="this.style.color='#374151';" onmouseout="this.style.color='#6b7280';">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
          <div style="position: relative; display: inline-block;">
            <div id="customerLogoPreviewContainer" class="logo-drop-zone" style="width: 180px; height: 180px; border-radius: 50%; overflow: hidden; border: 2px solid #e5e7eb; background: #f9fafb; display: flex; align-items: center; justify-content: center; position: relative; cursor: ${(customer.logo_url ? 'default' : 'pointer')}; transition: all 0.2s;${(!customer.logo_url ? 'onclick="document.getElementById(\'customerLogoUpload\').click();"' : '')} onmouseover=\"${(!customer.logo_url ? 'this.style.borderColor=\'#d1d5db\'; this.style.background=\'#f3f4f6\';' : '')}\" onmouseout=\"${(!customer.logo_url ? 'this.style.borderColor=\'#e5e7eb\'; this.style.background=\'#f9fafb\';' : '')}\">
              <img 
                id="customerLogoPreview" 
                src=\"${(customer.logo_url || '')}\" 
                alt=\"${(customer.name || customer.company_name || 'Klant')}\" 
                loading="lazy"
                decoding="async"
                width="180"
                height="180"
                style="max-width: 100%; max-height: 100%; object-fit: contain; display: ${(customer.logo_url ? 'block' : 'none')};"
              >
              ${(!customer.logo_url ? '<div id="logoPlaceholderContent" style="display:flex;flex-direction:column;align-items:center;gap:8px;color:#9ca3af;transition: all 0.2s;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.5;transition: all 0.2s;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><span style="font-size:13px;font-weight:500;">Upload logo</span></div>' : '')}
            </div>
          </div>
          <div style="display: flex; gap: 12px; width: 100%; justify-content: flex-end;">
            <button type="button" class="btn-outline" id="closeCustomerLogoModal" style="padding: 10px 20px; font-size: 14px; font-weight: 500; border-radius: 8px; background: white; border: 1px solid #e5e7eb; color: #374151; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#d1d5db';" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb';">
              Annuleren
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Drawer Styles -->
  <link rel="stylesheet" href="/css/admin/employees-drawer.css">
  
  <!-- Add Invoice Drawer (slide-in from right) -->
  <div id="invoiceDrawerOverlay" class="gs-drawer-overlay" aria-hidden="true" style="position:fixed;inset:0;background:rgba(11,18,32,0.55);opacity:0;pointer-events:none;z-index:9998;"></div>
  <aside id="invoiceDrawer" class="gs-drawer" aria-hidden="true" aria-label="Nieuwe Factuur" style="position:fixed;top:0;right:0;height:100vh;width:min(600px,92vw);background:#fff;border-left:1px solid rgba(17,24,39,0.08);box-shadow:-12px 0 40px rgba(0,0,0,0.18);transform:translateX(110%);z-index:9999;display:flex;flex-direction:column;">
    <div class="gs-drawer__header">
      <div>
        <h3 class="gs-drawer__title">Nieuwe Factuur Toevoegen</h3>
        <p class="gs-drawer__subtitle">Voeg een nieuwe factuur toe met meerdere regels en BTW.</p>
      </div>
      <button type="button" class="gs-drawer__close" onclick="closeAddInvoiceModal()" aria-label="Sluiten">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="addInvoiceForm">
      <div class="gs-drawer__body" style="overflow-y: auto;">
          <div id="addInvoiceFormError" class="gs-error" style="display: none;"></div>
          
          <div class="gs-form-group">
            <label class="gs-form-label">Factuurnummer *</label>
            <input type="text" id="invoiceNumber" name="invoice_number" class="gs-form-input" required placeholder="Bijv. GS-0828" />
          </div>
          
          <div class="gs-form-grid">
            <div class="gs-field">
              <label class="gs-label">Factuurdatum *</label>
              <input type="date" id="invoiceDate" name="invoice_date" class="gs-form-input" required />
            </div>
            <div class="gs-field">
              <label class="gs-label">Vervaldatum</label>
              <input type="date" id="dueDate" name="due_date" class="gs-form-input" />
            </div>
          </div>
          
          <div class="gs-form-group">
            <label class="gs-form-label">Ordernummer</label>
            <input type="text" id="orderNumber" name="order_number" class="gs-form-input" placeholder="Optioneel" />
          </div>
          
          <!-- Invoice Items Section -->
          <div class="gs-form-group">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <label class="gs-form-label" style="margin: 0;">Factuurregels *</label>
              <button type="button" onclick="addInvoiceItemRow()" class="gs-btn gs-btn--ghost" style="padding: 8px 12px; font-size: 13px;">
                <i class="fas fa-plus"></i> Regel toevoegen
              </button>
            </div>
            <div id="invoiceItemsList" style="display: flex; flex-direction: column; gap: 0.75rem;">
              <!-- Invoice items will be dynamically inserted here -->
            </div>
            <div style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px;">
              <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-weight: 500; color: #6b7280; font-size: 0.875rem;">Subtotaal (excl. BTW):</span>
                  <span id="invoiceSubtotalAmount" style="font-weight: 500; color: #374151; font-size: 0.875rem;">â‚¬0,00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-weight: 500; color: #6b7280; font-size: 0.875rem;">BTW (21%):</span>
                  <span id="invoiceVatAmount" style="font-weight: 500; color: #374151; font-size: 0.875rem;">â‚¬0,00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 0.5rem; border-top: 1px solid #e5e7eb; margin-top: 0.25rem;">
                  <span style="font-weight: 600; color: #374151; font-size: 0.875rem;">Totaal (incl. BTW):</span>
                  <span id="invoiceTotalAmount" style="font-weight: 700; color: #111827; font-size: 1.125rem;">â‚¬0,00</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="gs-form-grid">
            <div class="gs-field">
              <label class="gs-label">Bedrag (â‚¬) *</label>
              <input type="number" id="invoiceAmount" name="amount" class="gs-form-input" step="0.01" min="0" required placeholder="0.00" readonly style="background: #f9fafb; color: #6b7280;" />
              <p class="gs-hint">Wordt automatisch berekend op basis van factuurregels</p>
            </div>
            <div class="gs-field">
              <label class="gs-label">Openstaand bedrag (â‚¬)</label>
              <input type="number" id="outstandingAmount" name="outstanding_amount" class="gs-form-input" step="0.01" min="0" placeholder="0.00" />
              <p class="gs-hint">Laat leeg om gelijk te stellen aan totaal bedrag</p>
            </div>
          </div>
          
          <div class="gs-form-group">
            <label class="gs-form-label">Status *</label>
            <select id="invoiceStatus" name="status" class="gs-form-input" required>
              <option value="pending">In afwachting</option>
              <option value="paid">Betaald</option>
              <option value="overdue">Achterstallig</option>
              <option value="draft">Concept</option>
              <option value="cancelled">Geannuleerd</option>
            </select>
          </div>
          
          <div class="gs-form-group">
            <label class="gs-form-label">Notities</label>
            <textarea id="invoiceNotes" name="notes" class="gs-form-input" rows="3" placeholder="Optionele notities bij deze factuur..."></textarea>
          </div>
      </div>
      <div class="gs-drawer__footer">
        <button type="button" onclick="closeAddInvoiceModal()" class="gs-btn gs-btn--ghost">Annuleren</button>
        <button type="submit" class="gs-btn gs-btn--primary">
          <i class="fas fa-save"></i> Opslaan
        </button>
      </div>
    </form>
  </aside>

  <!-- Add Employee Modal -->
  <div id="addEmployeeModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 1.25rem; font-weight: 600; color: #111827; margin: 0;">Werknemer toevoegen</h2>
        <button type="button" id="closeAddEmployeeModal" style="background: none; border: none; cursor: pointer; padding: 4px; color: #6b7280; font-size: 1.5rem; line-height: 1;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="addEmployeeForm">
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 8px;">
            Werknemer *
          </label>
          <select id="employeeSelect" name="employee_id" required style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9375rem; background: white;">
            <option value="">Selecteer een werknemer...</option>
            ${((typeof customerData !== 'undefined' && customerData.allEmployees) ? customerData.allEmployees.map(function(emp) {
              var empName = (emp.first_name && emp.last_name) ? emp.first_name + ' ' + emp.last_name : emp.email || 'Onbekend'
              var isAssigned = (typeof customerData !== 'undefined' && customerData.responsibleEmployees) 
                ? customerData.responsibleEmployees.some(a => a.employee_id === emp.id)
                : false
              return isAssigned ? '' : '<option value="' + (emp.id || '') + '">' + empName + (emp.email ? ' (' + emp.email + ')' : '') + '</option>'
            }).join('') : '')}
          </select>
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 8px;">
            Type toewijzing
          </label>
          <select id="employeeRole" name="role" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9375rem; background: white;">
            <option value="responsible">Primair - Hoofdverantwoordelijke voor deze klant</option>
            <option value="backup">Secundair - Vervanger bij afwezigheid</option>
            <option value="observer">Informatief - Alleen op de hoogte, geen actie vereist</option>
          </select>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button type="button" id="cancelAddEmployee" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9375rem; font-weight: 500;">
            Annuleren
          </button>
          <button type="submit" style="padding: 10px 20px; background: #ea5d0d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9375rem; font-weight: 500;">
            Toevoegen
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Make employees data available to JavaScript
    window.customerEmployeesData = {
      customerId: '${(customer && customer.id ? customer.id : '')}',
      responsibleEmployees: " + JSON.stringify(typeof customerData !== 'undefined' && customerData.responsibleEmployees ? customerData.responsibleEmployees : [])},
      allEmployees: " + JSON.stringify(typeof customerData !== 'undefined' && customerData.allEmployees ? customerData.allEmployees : [])}
    };
    
    // Make labels available for edit mode
    window.statusLabels = ${JSON.stringify(statusLabels)};
    window.priorityLabels = ${JSON.stringify(priorityLabels)};
    window.currentStatus = '${status}';
    window.currentPriority = '${priority}';
    window.canEditCustomer = ${(typeof canEditCustomer !== 'undefined' ? canEditCustomer : false)};
    window.customerData = " + JSON.stringify(customer || {})};
    window.customerInvoicesData = {
      customerId: '${(customer && customer.id ? customer.id : '')}',
      invoices: " + JSON.stringify(typeof customerData !== 'undefined' && customerData.invoices ? customerData.invoices : [])}
    };
  </script>
  `;
    return output;
  })(),
  scripts: ['/js/admin/customer.js'],
  stylesheets: ['/css/admin/users.css', '/css/admin/customers.css', '/css/admin/payments-table.css']
}) %>

