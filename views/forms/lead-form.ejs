<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aanvraagformulier - <%= industry.name %></title>
  <meta name="description" content="Vraag een offerte aan voor <%= industry.name %>">
  
  <!-- Favicon -->
  <link rel="icon" type="image/webp" href="/img/favicon-growsocial.webp">
  <link rel="shortcut icon" type="image/webp" href="/img/favicon-growsocial.webp">
  <link rel="apple-touch-icon" href="/img/favicon-growsocial.webp">
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Analytics Tracker -->
  <script src="/js/forms/analytics-tracker.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f9fafb;
      color: #111827;
      line-height: 1.6;
    }
    
    /* Progress Bar (5px) */
    .form-progress-bar {
      width: 100%;
      height: 5px;
      background: #e5e7eb;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
    }
    
    .form-progress-fill {
      height: 100%;
      background: #ea5d0d;
      transition: width 0.3s ease-out;
    }
    
    /* Main Layout */
    .form-layout {
      display: flex;
      min-height: 100vh;
      padding-top: 5px;
    }
    
    /* Main Content */
    .form-main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      min-height: calc(100vh - 5px);
    }
    
    .form-step-container {
      max-width: 600px;
      width: 100%;
      animation: trustooSlideIn 0.3s ease-out;
    }
    
    @keyframes trustooSlideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .form-step-title {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 16px 0;
      line-height: 1.2;
    }
    
    .form-step-description {
      font-size: 16px;
      color: #6b7280;
      margin: 0 0 32px 0;
      line-height: 1.5;
    }
    
    /* Form Steps */
    .form-step {
      display: none;
    }
    
    .form-step.active {
      display: block;
    }
    
    /* Field Groups */
    .form-field-group {
      margin-bottom: 24px;
    }
    
    .form-field-group.half {
      display: inline-block;
      width: calc(50% - 12px);
      margin-right: 24px;
    }
    
    .form-field-group.half:last-child {
      margin-right: 0;
    }
    
    .form-field-label {
      display: block;
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    
    .form-required {
      color: #ef4444;
      margin-left: 4px;
    }
    
    .form-field-help {
      font-size: 14px;
      color: #6b7280;
      margin: 8px 0 16px 0;
    }
    
    /* Radio Cards (large, clickable) - 2 columns with circle checkpoint */
    .form-radio-cards {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    
    @media (max-width: 768px) {
      .form-radio-cards {
        grid-template-columns: 1fr;
      }
    }
    
    .form-radio-card {
      position: relative;
      display: block;
      cursor: pointer;
    }
    
    .form-radio-card input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    
    .form-card-content {
      padding: 12px 18px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: #ffffff;
      transition: all 0.2s ease-out;
      min-height: 56px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
    }
    
    /* Circle checkpoint indicator */
    .form-card-content::before {
      content: '';
      width: 24px;
      height: 24px;
      border: 3px solid #d1d5db;
      border-radius: 50%;
      background: #ffffff;
      transition: all 0.2s ease-out;
      flex-shrink: 0;
    }
    
    .form-radio-card:hover .form-card-content {
      border-color: #ea5d0d;
      background: #fff7ed;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(234, 93, 13, 0.15);
    }
    
    .form-radio-card:hover .form-card-content::before {
      border-color: #ea5d0d;
    }
    
    .form-radio-card input[type="radio"]:checked + .form-card-content {
      border-color: #ea5d0d;
      background: #fff7ed;
      box-shadow: 0 0 0 4px rgba(234, 93, 13, 0.1);
    }
    
    .form-radio-card input[type="radio"]:checked + .form-card-content::before {
      border-color: #ea5d0d;
      background: #ea5d0d;
      background-image: radial-gradient(circle, #ffffff 30%, transparent 30%);
    }
    
    .form-card-text {
      font-size: 16px;
      font-weight: 500;
      color: #111827;
      flex: 1;
    }
    
    .form-radio-card input[type="radio"]:checked + .form-card-content .form-card-text {
      color: #ea5d0d;
      font-weight: 600;
    }
    
    /* Textarea with Examples */
    .form-textarea {
      width: 100%;
      padding: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      transition: all 0.2s;
    }
    
    .form-textarea:focus {
      outline: none;
      border-color: #ea5d0d;
      box-shadow: 0 0 0 3px rgba(234, 93, 13, 0.1);
    }
    
    .form-examples {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    
    .form-examples-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      margin: 0 0 12px 0;
    }
    
    .form-example-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .form-example-chip {
      padding: 8px 16px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .form-example-chip:hover {
      background: #ea5d0d;
      color: #ffffff;
    }
    
    /* Input Fields */
    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
      transition: all 0.2s;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #ea5d0d;
      box-shadow: 0 0 0 3px rgba(234, 93, 13, 0.1);
    }
    
    .form-input.error {
      border-color: #ef4444;
    }
    
    /* Navigation */
    .form-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }
    
    .form-btn {
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease-out;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-btn-primary {
      background: #ea5d0d;
      color: #ffffff;
    }
    
    .form-btn-primary:hover {
      background: #d97706;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(234, 93, 13, 0.3);
    }
    
    .form-btn-secondary {
      background: #ffffff;
      color: #6b7280;
      border: 2px solid #e5e7eb;
    }
    
    .form-btn-secondary:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }
    
    .form-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Sidebar (Desktop only) */
    .form-sidebar {
      width: 320px;
      background: #f9fafb;
      border-left: 1px solid #e5e7eb;
      padding: 48px 32px;
      display: none;
      position: sticky;
      top: 5px;
      height: calc(100vh - 5px);
      overflow-y: auto;
    }
    
    @media (min-width: 1024px) {
      .form-sidebar {
        display: block;
      }
    }
    
    .form-sidebar-content {
      position: sticky;
      top: 24px;
    }
    
    .form-high-five {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .form-high-five svg {
      width: 120px;
      height: 120px;
    }
    
    .form-benefits h3 {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 16px 0;
    }
    
    .form-benefits ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .form-benefits li {
      font-size: 15px;
      color: #374151;
      margin-bottom: 12px;
      line-height: 1.6;
    }
    
    /* Error Messages */
    .form-error {
      color: #ef4444;
      font-size: 14px;
      margin-top: 8px;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .form-step-title {
        font-size: 24px;
      }
      
      .form-main {
        padding: 24px 16px;
      }
      
      .form-field-group.half {
        width: 100%;
        margin-right: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Progress Bar (5px - Trustoo style) -->
  <div class="form-progress-bar">
    <div class="form-progress-fill" id="progressFill" style="width: <%= (100 / template.steps.length) %>%"></div>
  </div>

  <!-- Main Layout -->
  <div class="form-layout">
    <!-- Main Content -->
    <div class="form-main">
      <form method="POST" action="/form/<%= slug %>/submit" id="leadForm" class="form-step-container">
        <% template.steps.forEach((step, stepIndex) => { %>
          <div class="form-step <%= stepIndex === 0 ? 'active' : '' %>" data-step="<%= stepIndex + 1 %>" data-step-id="<%= step.id || `step-${stepIndex + 1}` %>">
            <h1 class="form-step-title"><%= step.title %></h1>
            <% if (step.description) { %>
              <p class="form-step-description"><%= step.description %></p>
            <% } %>
            
            <div class="form-fields">
              <% step.fields.forEach(field => { %>
                <div class="form-field-group <%= field.width === 'half' ? 'half' : '' %>">
                  <label class="form-field-label" for="<%= field.id %>">
                    <%= field.label %>
                    <% if (field.required) { %>
                      <span class="form-required">*</span>
                    <% } %>
                  </label>
                  
                  <% if (field.helpText) { %>
                    <p class="form-field-help"><%= field.helpText %></p>
                  <% } %>
                  
                  <!-- Radio Cards -->
                  <% if (field.type === 'radio-cards' || (field.type === 'select' && field.options && field.options.length > 0)) { %>
                    <div class="form-radio-cards">
                      <% if (field.options && Array.isArray(field.options)) { %>
                        <% field.options.forEach((option, optIndex) => { %>
                          <label class="form-radio-card">
                            <input
                              type="radio"
                              name="<%= field.id %>"
                              id="<%= field.id %>-<%= optIndex %>"
                              value="<%= typeof option === 'string' ? option : option.value || option %>"
                              <%= field.required ? 'required' : '' %>
                              <%= values[field.id] === (typeof option === 'string' ? option : option.value || option) ? 'checked' : '' %>
                            >
                            <div class="form-card-content">
                              <span class="form-card-text">
                                <%= typeof option === 'string' ? option : option.label || option.value || option %>
                              </span>
                            </div>
                          </label>
                        <% }); %>
                      <% } %>
                    </div>
                  <% } else if (field.type === 'textarea-with-examples' || field.type === 'textarea') { %>
                    <!-- Textarea with Example Sentences -->
                    <textarea
                      id="<%= field.id %>"
                      name="<%= field.id %>"
                      class="form-textarea <%= errors[field.id] ? 'error' : '' %>"
                      rows="6"
                      placeholder="<%= field.placeholder || '' %>"
                      <%= field.required ? 'required' : '' %>
                    ><%= values[field.id] || '' %></textarea>
                    
                    <% if (field.exampleSentences && field.exampleSentences.length > 0) { %>
                      <div class="form-examples">
                        <p class="form-examples-title">Voorbeelden:</p>
                        <div class="form-example-chips">
                          <% field.exampleSentences.forEach(example => { %>
                            <button type="button" class="form-example-chip" onclick="insertExample('<%= field.id %>', '<%= example.replace(/'/g, "\\'") %>')">
                              <%= example %>
                            </button>
                          <% }); %>
                        </div>
                      </div>
                    <% } %>
                  <% } else { %>
                    <!-- Regular Input Fields -->
                    <input
                      type="<%= field.type || 'text' %>"
                      id="<%= field.id %>"
                      name="<%= field.id %>"
                      class="form-input <%= errors[field.id] ? 'error' : '' %>"
                      placeholder="<%= field.placeholder || '' %>"
                      value="<%= values[field.id] || '' %>"
                      <%= field.required ? 'required' : '' %>
                    >
                  <% } %>
                  
                  <% if (errors[field.id]) { %>
                    <p class="form-error"><%= errors[field.id] %></p>
                  <% } %>
                </div>
              <% }); %>
            </div>
            
            <!-- Navigation -->
            <div class="form-navigation">
              <button
                type="button"
                id="prevBtn"
                class="form-btn form-btn-secondary"
                style="<%= stepIndex === 0 ? 'display: none;' : '' %>"
              >
                ← Vorige
              </button>
              <div></div>
              <% if (stepIndex < template.steps.length - 1) { %>
                <button
                  type="button"
                  id="nextBtn"
                  class="form-btn form-btn-primary"
                >
                  Volgende →
                </button>
              <% } else { %>
                <button
                  type="submit"
                  id="submitBtn"
                  class="form-btn form-btn-primary"
                >
                  <%= template.settings?.submitButtonText || 'Verstuur aanvraag' %>
                </button>
              <% } %>
            </div>
          </div>
        <% }); %>
      </form>
    </div>
    
    <!-- Sidebar (Desktop only) -->
    <div class="form-sidebar">
      <div class="form-sidebar-content">
        <div class="form-high-five">
          <svg width="120" height="120" viewBox="0 0 120 120" fill="none">
            <circle cx="60" cy="60" r="55" fill="#fef3c7" stroke="#fbbf24" stroke-width="2"/>
            <path d="M45 50 L55 60 L45 70 M75 50 L65 60 L75 70" stroke="#f59e0b" stroke-width="3" stroke-linecap="round"/>
            <path d="M50 80 Q60 85 70 80" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" fill="none"/>
          </svg>
        </div>
        <div class="form-benefits">
          <h3>Waarom via ons?</h3>
          <ul>
            <li>✓ Direct contact met lokale bedrijven</li>
            <li>✓ Vrijblijvend vergelijken</li>
            <li>✓ 80% binnen 24 uur reactie</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Initialize Analytics Tracker
    const analyticsTracker = new FormAnalyticsTracker({
      industryId: <%= industry.id %>,
      formTemplateId: '<%= template.id || null %>',
      slug: '<%= slug %>'
    });

    // Multi-step form logic
    let currentStep = 1;
    const totalSteps = <%= template.steps.length %>;
    const steps = <%- JSON.stringify(template.steps) %>;
    
    function showStep(step) {
      // Track step completion (if moving forward)
      if (step > currentStep && currentStep > 0) {
        const prevStepData = steps[currentStep - 1];
        const fieldValues = {};
        
        // Collect field values from previous step
        const prevStepElement = document.querySelector(`[data-step="${currentStep}"]`);
        if (prevStepElement) {
          prevStepElement.querySelectorAll('input, select, textarea').forEach(field => {
            if (field.name && field.value) {
              fieldValues[field.name] = field.value;
            }
          });
        }
        
        // Track step completion
        analyticsTracker.trackStepComplete(
          prevStepData.id || `step-${currentStep}`,
          fieldValues
        );
      }
      
      // Hide all steps with slide animation
      document.querySelectorAll('.form-step').forEach(s => {
        s.classList.remove('active');
      });
      
      // Show current step with slide animation
      const stepElement = document.querySelector(`[data-step="${step}"]`);
      if (stepElement) {
        stepElement.classList.add('active');
      }
      
      // Track step start
      const stepData = steps[step - 1];
      if (stepData) {
        analyticsTracker.trackStepStart(
          stepData.id || `step-${step}`,
          stepData.order || step,
          stepData.title || `Stap ${step}`
        );
      }
      
      // Update progress bar
      const progress = (step / totalSteps) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      
      // Show/hide navigation buttons
      const prevBtn = document.querySelector(`[data-step="${step}"]`).querySelector('#prevBtn');
      const nextBtn = document.querySelector(`[data-step="${step}"]`).querySelector('#nextBtn');
      const submitBtn = document.querySelector(`[data-step="${step}"]`).querySelector('#submitBtn');
      
      if (prevBtn) prevBtn.style.display = step > 1 ? 'flex' : 'none';
      if (nextBtn) nextBtn.style.display = step < totalSteps ? 'flex' : 'none';
      if (submitBtn) submitBtn.style.display = step === totalSteps ? 'flex' : 'none';
    }
    
    // Insert example sentence
    function insertExample(fieldId, example) {
      const textarea = document.getElementById(fieldId);
      if (textarea) {
        textarea.value = example;
        textarea.focus();
      }
    }
    
    // Track field interactions
    document.addEventListener('change', function(e) {
      if (e.target.matches('input, select, textarea')) {
        const field = e.target;
        const fieldId = field.name || field.id;
        const fieldType = field.type || field.tagName.toLowerCase();
        const fieldValue = field.value;
        
        // Find field definition
        const currentStepData = steps[currentStep - 1];
        if (currentStepData) {
          const fieldDef = currentStepData.fields?.find(f => f.id === fieldId);
          if (fieldDef) {
            analyticsTracker.trackFieldChange(
              fieldId,
              fieldDef.type || fieldType,
              null,
              fieldValue,
              fieldDef.options || []
            );
          }
        }
      }
    });
    
    // Next button (all steps)
    document.addEventListener('click', function(e) {
      if (e.target.closest('#nextBtn')) {
        const stepElement = document.querySelector(`[data-step="${currentStep}"]`);
        const requiredFields = stepElement.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
          if (!field.value || field.value.trim() === '') {
            isValid = false;
            field.classList.add('error');
          } else {
            field.classList.remove('error');
          }
        });
        
        if (isValid && currentStep < totalSteps) {
          currentStep++;
          showStep(currentStep);
        }
      }
    });
    
    // Previous button (all steps)
    document.addEventListener('click', function(e) {
      if (e.target.closest('#prevBtn')) {
        if (currentStep > 1) {
          currentStep--;
          showStep(currentStep);
        }
      }
    });
    
    // Form submission
    document.getElementById('leadForm').addEventListener('submit', function(e) {
      // Track final step completion
      const finalStepData = steps[currentStep - 1];
      if (finalStepData) {
        const fieldValues = {};
        const finalStepElement = document.querySelector(`[data-step="${currentStep}"]`);
        if (finalStepElement) {
          finalStepElement.querySelectorAll('input, select, textarea').forEach(field => {
            if (field.name && field.value) {
              fieldValues[field.name] = field.value;
            }
          });
        }
        
        analyticsTracker.trackStepComplete(
          finalStepData.id || `step-${currentStep}`,
          fieldValues
        );
      }
    });
    
    // Initialize Google Maps Autocomplete for postcode and city
    <% if (typeof googleMapsApiKey !== "undefined" && googleMapsApiKey && googleMapsApiKey !== "") { %>
    <script>
      window.GOOGLE_MAPS_API_KEY = '<%= googleMapsApiKey %>';
      
      // Initialize Google Maps Autocomplete
      function initGoogleMapsAutocomplete() {
        if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
          setTimeout(initGoogleMapsAutocomplete, 100);
          return;
        }
        
        // Import places library if needed
        if (typeof google.maps.places === 'undefined') {
          if (typeof google.maps.importLibrary === 'function') {
            google.maps.importLibrary('places').then(function() {
              setupAutocomplete();
            }).catch(function(err) {
              console.error('Error loading Places library:', err);
            });
          } else {
            setTimeout(initGoogleMapsAutocomplete, 100);
          }
          return;
        }
        
        setupAutocomplete();
      }
      
      function setupAutocomplete() {
        const postcodeInput = document.getElementById('postcode');
        const cityInput = document.getElementById('city');
        
        if (postcodeInput && typeof google.maps.places.Autocomplete !== 'undefined') {
          const postcodeAutocomplete = new google.maps.places.Autocomplete(postcodeInput, {
            componentRestrictions: { country: ['nl', 'be'] },
            fields: ['address_components', 'formatted_address'],
            types: ['postal_code']
          });
          
          postcodeAutocomplete.addListener('place_changed', function() {
            const place = postcodeAutocomplete.getPlace();
            if (place.address_components) {
              place.address_components.forEach(component => {
                if (component.types.includes('postal_code') && postcodeInput) {
                  postcodeInput.value = component.long_name;
                }
                if (component.types.includes('locality') && cityInput) {
                  cityInput.value = component.long_name;
                }
              });
            }
          });
        }
        
        if (cityInput && typeof google.maps.places.Autocomplete !== 'undefined') {
          const cityAutocomplete = new google.maps.places.Autocomplete(cityInput, {
            componentRestrictions: { country: ['nl', 'be'] },
            fields: ['address_components', 'formatted_address'],
            types: ['(cities)']
          });
          
          cityAutocomplete.addListener('place_changed', function() {
            const place = cityAutocomplete.getPlace();
            if (place.address_components) {
              place.address_components.forEach(component => {
                if (component.types.includes('locality') && cityInput) {
                  cityInput.value = component.long_name;
                }
                if (component.types.includes('postal_code') && postcodeInput) {
                  postcodeInput.value = component.long_name;
                }
              });
            }
          });
        }
      }
      
      // Load Google Maps API
      if (window.GOOGLE_MAPS_API_KEY) {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GOOGLE_MAPS_API_KEY}&libraries=places&language=nl&callback=initGoogleMapsAutocomplete`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
      }
    </script>
    <% } %>
    
    // Initialize
    showStep(1);
  </script>
</body>
</html>
