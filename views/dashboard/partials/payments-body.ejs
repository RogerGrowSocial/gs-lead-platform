<% 
  // Veilige defaults
  const _user = typeof user !== 'undefined' ? user : null;
  const _payments = Array.isArray(payments) ? payments : [];
  const _stats = typeof stats !== 'undefined' && stats ? stats : null;
  const _paymentMethods = Array.isArray(paymentMethods) ? paymentMethods : [];
  const _hasPaymentMethod = _paymentMethods && _paymentMethods.length > 0;
  const _userHasPaymentMethod = user && user.has_payment_method === true;
  const _mollieProfileId = typeof mollieProfileId !== 'undefined' ? mollieProfileId : '';

  // Gebruik alleen echte betalingen, geen sample data
  const allPayments = _payments || [];
  
  // Limit to 5 payments for display
  const displayPayments = allPayments.slice(0, 5);

  // Bereken statistieken op basis van de betalingen
  const paymentStats = {
    totalPaid: allPayments.filter(p => p.status === 'paid' || p.status === 'completed').reduce((sum, p) => sum + parseFloat(p.amount || 0), 0),
    pendingAmount: allPayments.filter(p => p.status === 'pending').reduce((sum, p) => sum + parseFloat(p.amount || 0), 0),
    totalTransactions: allPayments.length,
    pendingCount: allPayments.filter(p => p.status === 'pending').length,
    completedCount: allPayments.filter(p => p.status === 'paid' || p.status === 'completed').length,
    failedCount: allPayments.filter(p => p.status === 'failed').length
  };

  // Gebruik de berekende statistieken of de originele als ze bestaan
  const displayStats = _stats || paymentStats;

  // Huidige saldo (kan worden aangepast op basis van gebruikersgegevens)
  const currentBalance = (user && user.balance !== null && user.balance !== undefined) ? parseFloat(user.balance) : 0.00;
%>

  <!-- Melding bovenaan de pagina - Alleen tonen als er geen betaalmethode is -->
  <% if (!_hasPaymentMethod && !_userHasPaymentMethod) { %>
  <div class="alert alert-info d-flex align-items-center mb-4" role="alert" style="background-color: var(--info-light); border-color: var(--info-color);">
    <div style="font-size: 1.5rem; color: var(--info-color); margin-right: 15px;">
      <i class="fas fa-info-circle"></i>
    </div>
    <div>
      <strong>Tip:</strong> Je hebt momenteel nog geen betaalrekening gekoppeld. Koppel een rekening of waardeer je saldo op om aanvragen te ontvangen.
    </div>
    <button type="button" class="close ml-auto" data-dismiss="alert" aria-label="Close" style="padding-left: 15px;">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <% } %>

  <div class="card-container">
    <!-- Volgende betaling -->
    <div class="card">
      <div class="card-content">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <p class="card-title">Volgende betaling</p>
            <p style="font-size: 1.5rem; font-weight: 700; color: #111827; margin-top: 0.25rem; margin-bottom: 0;">
              € <%= (typeof nextPaymentAmount !== 'undefined' ? nextPaymentAmount : 0).toFixed(2).replace('.', ',') %>
            </p>
          </div>
          <div style="height: 4rem; width: 4rem; background-color: #F3F4F6; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <i class="far fa-credit-card" style="font-size: 1.5rem; color: #4B5563;"></i>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Volgende factuurdatum -->
    <div class="card">
      <div class="card-content">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <p class="card-title">Volgende factuurdatum</p>
            <p style="font-size: 1.5rem; font-weight: 700; color: #111827; margin-top: 0.25rem; margin-bottom: 0;">
              <% if (!_hasPaymentMethod && !_userHasPaymentMethod) { %>
                —
              <% } else if (nextInvoiceDate) { %>
                <%= new Date(nextInvoiceDate).toLocaleDateString("nl-NL", { 
                  day: '2-digit', 
                  month: '2-digit', 
                  year: 'numeric' 
                }) %>
              <% } else { %>
                —
              <% } %>
            </p>
          </div>
          <div style="height: 4rem; width: 4rem; background-color: #F3F4F6; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <i class="far fa-calendar-alt" style="font-size: 1.5rem; color: #4B5563;"></i>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Aanvragen afgelopen periode -->
    <div class="card">
      <div class="card-content">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <p class="card-title">Aanvragen afgelopen periode</p>
            <p style="font-size: 1.5rem; font-weight: 700; color: #111827; margin-top: 0.25rem; margin-bottom: 0;">
              <%= recentLeadsCount || 0 %>
            </p>
          </div>
          <div style="height: 4rem; width: 4rem; background-color: #F3F4F6; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <i class="far fa-file-alt" style="font-size: 1.5rem; color: #4B5563;"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Two Column Layout: Betalingen overzicht + Bankrekening toevoegen -->
  <div class="dashboard-split">
    
    <!-- Left Column - Betalingen overzicht (67% width) -->
    <section class="payments-section">
      <div style="border: 1px solid #F3F4F6; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); background-color: #FFFFFF; border-radius: var(--radius-md); display: flex; flex-direction: column; height: 100%;">
        <div style="padding-top: 24px; padding-left: 24px; padding-right: 24px; padding-bottom: 31px;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
              <h2 style="font-size: 20px; font-weight: 600; color: #111827; margin: 0; line-height: 1.2;">Betalingen overzicht</h2>
              <p style="font-size: 14px; font-weight: 400; color: #4B5563; margin: 0; margin-top: 4px; line-height: 1.4;">Alle betalingen en transacties</p>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <span style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; background-color: #F3F4F6; color: #374151; border: none;">Alle betalingen: <%= _stats ? _stats.totalTransactions : 0 %></span>
              <span style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; background-color: #DCFCE7; color: #15803D; border: none;">Voltooid: <%= _stats ? _stats.completedCount : 0 %></span>
              <span style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; background-color: #F3F4F6; color: #374151; border: none;">Openstaand: <%= _stats ? _stats.pendingCount : 0 %></span>
              <% if (_stats && _stats.failedCount > 0) { %>
              <span style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; background-color: #FEE2E2; color: #991B1B; border: none;">Mislukt: <%= _stats.failedCount %></span>
              <% } %>
            </div>
          </div>
        </div>
        
        <div style="padding-left: 24px; padding-right: 24px; padding-bottom: 24px; padding-top: 0; flex: 1; display: flex; flex-direction: column;">
          <div style="border-radius: 8px; border: 1px solid #F3F4F6; overflow: visible; flex: 1; display: flex; flex-direction: column;">
            <style>
              /* Prevent font swap jump specifically on the payments table */
              #allPaymentsTable th,
              #allPaymentsTable td {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif !important;
                font-size-adjust: 0.52;
              }
            </style>
            <table class="table table-hover" id="allPaymentsTable" style="width: 100%; table-layout: fixed; flex: 1;">
              <thead style="border-top: none;">
                <tr style="background-color: #F9FAFB; border-top: none;">
                  <th style="font-weight: 500; color: #374151; padding: 12px; border: none; width: 22%; font-size: 16px;">Datum</th>
                  <th style="font-weight: 500; color: #374151; padding: 12px; border: none; width: 18%; font-size: 16px;">Bedrag</th>
                  <th style="font-weight: 500; color: #374151; padding: 12px; border: none; width: 45%; font-size: 16px;">Beschrijving</th>
                  <th style="font-weight: 500; color: #374151; padding: 12px; border: none; width: 10%; font-size: 16px;">Status</th>
                  <th style="font-weight: 500; color: #374151; padding: 12px; border: none; width: 5%; font-size: 16px;"></th>
                </tr>
              </thead>
              <tbody>
                <% if (displayPayments.length > 0) { %>
                  <% displayPayments.forEach(function(payment) { %>
                    <tr>
                      <td style="padding: 12px; border: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px;"><%= new Date(payment.created_at).toLocaleDateString("nl-NL") %></td>
                      <td style="padding: 12px; border: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px;">€ <%= parseFloat(payment.amount).toFixed(2) %></td>
                      <td style="padding: 12px; border: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px;">
                        <% 
                          // Bepaal beschrijving op basis van beschikbare velden
                          let displayDescription = 'Betaling #' + payment.id.substring(0, 8);
                          let periodInfo = '';
                          
                          // Parse payment_details voor maand/period informatie
                          let paymentDetails = null;
                          if (payment.payment_details) {
                            try {
                              paymentDetails = typeof payment.payment_details === 'string' 
                                ? JSON.parse(payment.payment_details) 
                                : payment.payment_details;
                            } catch (e) {
                              // Ignore parse errors
                            }
                          }
                          
                          // Bepaal periode/maand van payment
                          if (paymentDetails) {
                            // Check voor billing_date (format: YYYY-MM-DD)
                            if (paymentDetails.billing_date) {
                              const billingDate = new Date(paymentDetails.billing_date);
                              const monthNames = ['Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni', 'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'];
                              const month = monthNames[billingDate.getMonth()];
                              periodInfo = `Aanvragen ${month}`;
                            }
                            // Check voor period_month (format: YYYY-MM-01)
                            else if (paymentDetails.period_month) {
                              const periodDate = new Date(paymentDetails.period_month);
                              const monthNames = ['Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni', 'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'];
                              const month = monthNames[periodDate.getMonth()];
                              periodInfo = `Aanvragen ${month}`;
                            }
                            // Check voor leads_count en gebruik payment date maand
                            else if (paymentDetails.leads_count) {
                              const paymentDate = new Date(payment.created_at);
                              const monthNames = ['Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni', 'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'];
                              const month = monthNames[paymentDate.getMonth()];
                              periodInfo = `Aanvragen ${month}`;
                            }
                            
                            // Als er een description is, gebruik die
                            if (paymentDetails.description) {
                              displayDescription = paymentDetails.description;
                            }
                          }
                          
                          // 1) Factuurnummer indien aanwezig op payments
                          if (payment.invoice_number && !displayDescription.includes('Factuur')) {
                            displayDescription = 'Factuur ' + payment.invoice_number;
                          }
                          
                          // Combineer description met period info als beschikbaar
                          if (periodInfo) {
                            displayDescription = periodInfo + (displayDescription ? ' - ' + displayDescription : '');
                          }
                        %>
                        <%= displayDescription %>
                      </td>
                      <td style="padding: 12px; border: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px;">
                        <% if (payment.status === "completed" || payment.status === "paid") { %>
                          <span style="display: inline-flex; align-items: center; padding: 2px 10px; border-radius: 9999px; font-size: 12px; font-weight: 500; background-color: #DCFCE7; color: #15803D;">Voltooid</span>
                        <% } else if (payment.status === "pending") { %>
                          <span style="display: inline-flex; align-items: center; padding: 2px 10px; border-radius: 9999px; font-size: 12px; font-weight: 500; background-color: #F3F4F6; color: #374151;">Openstaand</span>
                        <% } else if (payment.status === "failed") { %>
                          <span style="display: inline-flex; align-items: center; padding: 2px 10px; border-radius: 9999px; font-size: 12px; font-weight: 500; background-color: #FEE2E2; color: #991B1B;">Mislukt</span>
                        <% } else { %>
                          <span style="display: inline-flex; align-items: center; padding: 2px 10px; border-radius: 9999px; font-size: 12px; font-weight: 500; background-color: #F3F4F6; color: #374151;"><%= payment.status %></span>
                        <% } %>
                      </td>
                      <td style="padding: 12px 24px 12px 12px; border: none; font-size: 14px; width: 80px;">
                        <% if (payment.status === "completed" || payment.status === "paid") { %>
                          <div style="display: flex; justify-content: flex-end; align-items: center;">
                            <a href="/dashboard/payments/<%= payment.id %>/invoice" 
                               class="download-invoice-btn" 
                               data-payment-id="<%= payment.id %>"
                               title="Factuur downloaden"
                               style="padding: 8px; border: none; background: none; color: #6B7280; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; border-radius: 6px; width: 32px; height: 32px;">
                              <i class="fas fa-download" style="font-size: 16px;"></i>
                            </a>
                          </div>
                        <% } %>
                      </td>
                    </tr>
                  <% }); %>
                <% } else { %>
                  <tr style="height: 100%; background-color: transparent !important;">
                    <td colspan="5" style="padding: 0; text-align: center; color: #9CA3AF; font-size: 14px; font-weight: 400; height: 100%; vertical-align: middle; position: relative; background-color: transparent !important;">
                      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; text-align: center;">
                        Geen betalingen verricht
                      </div>
                    </td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
          
          <!-- Clean link to payment methods settings -->
          <div style="text-align: right; margin-top: 16px; padding-right: 8px;">
            <a href="/dashboard/settings/payment" style="font-size: 13px; color: #6B7280; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
              <i class="fas fa-list-alt" style="font-size: 12px;"></i>
              Alle betalingen
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Right Column - Bankrekening toevoegen (33% width) -->
    <section class="bank-section" data-tour-id="payment-method">
      <div style="border: 1px solid #F3F4F6; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); background-color: #FFFFFF; border-radius: var(--radius-md); display: flex; flex-direction: column; height: 100%;">
        <div style="padding-top: 24px; padding-left: 24px; padding-right: 24px; padding-bottom: 31px;">
          <h2 style="font-size: 20px; font-weight: 600; color: #111827; margin: 0; line-height: 1.2;">Bankrekening toevoegen</h2>
          <p style="font-size: 14px; font-weight: 400; color: #4B5563; margin: 0; margin-top: 4px; line-height: 1.4;">Beheer je bankgegevens</p>
        </div>
        <div style="padding-left: 24px; padding-right: 24px; padding-bottom: 24px; padding-top: 0; flex: 1; display: flex; flex-direction: column;">
          <div style="flex: 1;">
            <%- include('../../partials/payment-method-toggle') %>
          </div>
          
          <!-- Extra informatie sectie -->
          <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #E5E7EB;">
            <!-- Automatisch -->
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <div style="width: 40px; height: 40px; background-color: #F3F4F6; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <i class="fas fa-sync-alt" style="font-size: 18px; color: #6B7280;"></i>
              </div>
              <div style="flex: 1;">
                <h3 style="font-size: 14px; font-weight: 600; color: #111827; margin: 0 0 4px 0;">Automatische Incasso</h3>
                <p style="font-size: 13px; color: #6B7280; margin: 0; line-height: 1.4;">Betalingen worden automatisch afgeschreven wanneer je nieuwe aanvragen ontvangt. Geen handmatige actie nodig.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Payment Details Modal -->
  <div class="modal fade" id="paymentDetailsModal" role="dialog" aria-labelledby="paymentDetailsModalLabel">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="paymentDetailsModalLabel">Betaling details</h5>
          <button type="button" class="close" id="closePaymentDetailsModal" aria-label="Sluiten">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="payment-details-content">
            <!-- Content will be dynamically populated -->
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Laden...</span>
              </div>
              <p class="mt-2">Betalingsgegevens laden...</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="closePaymentDetailsBtn">Sluiten</button>
          <button type="button" class="btn btn-primary download-invoice-modal" style="display: none;">Factuur downloaden</button>
          <button type="button" class="btn btn-success pay-now-modal" style="display: none;">Nu betalen</button>
          <button type="button" class="btn btn-warning retry-payment-modal" style="display: none;">Opnieuw proberen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Invoice Modal -->
  <div class="modal fade" id="createInvoiceModal" tabindex="-1" role="dialog" aria-labelledby="createInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createInvoiceModalLabel">Factuur aanmaken</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="createInvoiceForm" class="needs-validation" novalidate>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="customerName">Klantnaam</label>
                <input type="text" class="form-control" id="customerName" name="customerName" required>
                <div class="invalid-feedback">Vul een klantnaam in.</div>
              </div>
              <div class="form-group col-md-6">
                <label for="customerEmail">E-mailadres</label>
                <input type="email" class="form-control" id="customerEmail" name="customerEmail" required>
                <div class="invalid-feedback">Vul een geldig e-mailadres in.</div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="invoiceDate">Factuurdatum</label>
                <input type="date" class="form-control" id="invoiceDate" name="invoiceDate" required>
                <div class="invalid-feedback">Selecteer een factuurdatum.</div>
              </div>
              <div class="form-group col-md-6">
                <label for="dueDate">Vervaldatum</label>
                <input type="date" class="form-control" id="dueDate" name="dueDate" required>
                <div class="invalid-feedback">Selecteer een vervaldatum.</div>
              </div>
            </div>

            <div class="form-group">
              <label for="description">Beschrijving</label>
              <input type="text" class="form-control" id="description" name="description" required>
              <div class="invalid-feedback">Vul een beschrijving in.</div>
            </div>

            <div class="form-group">
              <label for="amount">Bedrag (€)</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">€</span>
                </div>
                <input type="number" class="form-control" id="amount" name="amount" min="0" step="0.01" required>
                <div class="invalid-feedback">Vul een geldig bedrag in.</div>
              </div>
            </div>

            <div class="form-group">
              <label for="paymentMethod">Betaalmethode</label>
              <select class="form-control" id="paymentMethod" name="paymentMethod" required>
                <option value="">Selecteer een betaalmethode</option>
                <option value="ideal">iDEAL</option>
                <option value="creditcard">Creditcard</option>
                <option value="bancontact">Bancontact</option>
              </select>
              <div class="invalid-feedback">Selecteer een betaalmethode.</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuleren</button>
          <button type="button" class="btn btn-primary" id="submitInvoice">Factuur aanmaken</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Business Details Modal -->
  <div class="modal fade custom-business-modal" id="businessDetailsModal" tabindex="-1" role="dialog" aria-labelledby="businessDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content business-modal-content">
        <div class="modal-header business-modal-header">
          <div>
            <div class="business-modal-title">Factuurgegevens toevoegen</div>
            <div class="business-modal-subtitle">Vul je bedrijfsgegevens in om je betaalmethode in te stellen</div>
          </div>
          <button type="button" class="close business-modal-close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body business-modal-body">
          <form id="businessDetailsForm" class="needs-validation" novalidate>
            <div class="form-group">
              <label for="companyName">Bedrijfsnaam <span class="required">*</span></label>
              <input type="text" class="form-control" id="companyName" name="companyName" placeholder="Voer je bedrijfsnaam in" required>
              <div class="invalid-feedback">Vul een bedrijfsnaam in.</div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="postalCode">Postcode <span class="required">*</span></label>
                <input type="text" class="form-control" id="postalCode" name="postalCode" placeholder="1234 AB" required>
                <div class="invalid-feedback">Vul een postcode in.</div>
              </div>
              <div class="form-group col-md-6">
                <label for="city">Plaats <span class="required">*</span></label>
                <input type="text" class="form-control" id="city" name="city" placeholder="Amsterdam" required>
                <div class="invalid-feedback">Vul een plaats in.</div>
              </div>
            </div>
            <div class="form-group">
              <label for="country">Land <span class="required">*</span></label>
              <input type="text" class="form-control" id="country" name="country" value="Nederland" required readonly>
              <div class="invalid-feedback">Selecteer een land.</div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="vatNumber">BTW-nummer <span class="required">*</span></label>
                <input type="text" class="form-control" id="vatNumber" name="vatNumber" placeholder="NL123456789B01" required>
                <div class="invalid-feedback">Vul een BTW nummer in.</div>
              </div>
              <div class="form-group col-md-6">
                <label for="cocNumber">KvK-nummer <span class="required">*</span></label>
                <input type="text" class="form-control" id="cocNumber" name="cocNumber" placeholder="12345678" required>
                <div class="invalid-feedback">Vul een KvK nummer in.</div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer business-modal-footer">
          <button type="button" class="btn business-btn-cancel" data-dismiss="modal">Annuleren</button>
          <button type="button" class="btn business-btn-save" id="saveBusinessDetails">Gegevens opslaan</button>
        </div>
      </div>
    </div>
  </div>

<script>
// Update leads count when new leads are received
function updateLeadsCount() {
  // Get leads count from the third card's value
  const cardTitles = document.querySelectorAll('.card-title');
  let leadsCountElement = null;
  
  cardTitles.forEach(title => {
    if (title.textContent.includes('Aanvragen afgelopen periode')) {
      leadsCountElement = title.parentElement?.querySelector('p[style*="font-size: 1.5rem"]');
    }
  });
  
  if (leadsCountElement) {
    const currentCount = parseInt(leadsCountElement.textContent) || 0;
    return currentCount;
  }
  return 0;
}

// Listen for leads updates
document.addEventListener('DOMContentLoaded', function() {
  updateLeadsCount();
  
  // Listen for custom events from leads system
  window.addEventListener('leadsUpdated', function(event) {
    if (event.detail && event.detail.newCount !== undefined) {
      // Update the main count display in the third card
      const cardTitles = document.querySelectorAll('.card-title');
      let leadsCountElement = null;
      
      cardTitles.forEach(title => {
        if (title.textContent.includes('Aanvragen afgelopen periode')) {
          leadsCountElement = title.parentElement?.querySelector('p[style*="font-size: 1.5rem"]');
        }
      });
      
      if (leadsCountElement) {
        leadsCountElement.textContent = event.detail.newCount;
      }
    }
  });
  
  // Handle navigation to payment methods tab
  const paymentLink = document.querySelector('a[href="/dashboard/settings#payment"]');
  if (paymentLink) {
    paymentLink.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Navigate to settings page
      window.location.href = '/dashboard/settings';
      
      // After navigation, activate the payment tab
      setTimeout(function() {
        const paymentTab = document.querySelector('a[href="#payment"]');
        if (paymentTab) {
          paymentTab.click();
        }
      }, 100);
    });
  }

  // Add hover effect and download handler for PDF download buttons
  // Setup immediately, don't wait for DOMContentLoaded
  function setupInvoiceDownloadButtons() {
    const downloadBtns = document.querySelectorAll('.download-invoice-btn');
    downloadBtns.forEach(btn => {
      // Check if already has listener
      if (btn.dataset.listenerAdded) return;
      btn.dataset.listenerAdded = 'true';
      
      // Add hover tooltip effect
      btn.addEventListener('mouseenter', function() {
        this.style.color = '#3B82F6';
        this.style.backgroundColor = '#EFF6FF';
        this.style.transform = 'scale(1.1)';
      });
      btn.addEventListener('mouseleave', function() {
        this.style.color = '#6B7280';
        this.style.backgroundColor = 'transparent';
        this.style.transform = 'scale(1)';
      });
      
      // Handle download via fetch to ensure proper download
      btn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const url = this.getAttribute('href');
        const paymentId = this.getAttribute('data-payment-id');
        
        if (!url) return;
        
        // Create a FULL SCREEN OVERLAY with loading spinner - impossible to miss!
        const overlay = document.createElement('div');
        const overlayId = 'invoice-download-overlay-' + Date.now();
        overlay.id = overlayId;
        overlay.style.cssText = `
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          background: rgba(0, 0, 0, 0.5) !important;
          z-index: 99999999 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          pointer-events: auto !important;
        `;
        
        const spinnerBox = document.createElement('div');
        spinnerBox.style.cssText = `
          background: #ffffff !important;
          border-radius: 12px !important;
          padding: 32px 40px !important;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
          display: flex !important;
          flex-direction: column !important;
          align-items: center !important;
          gap: 16px !important;
          min-width: 280px !important;
        `;
        
        spinnerBox.innerHTML = `
          <div style="width: 48px; height: 48px; border: 4px solid #E5E7EB; border-top-color: #3B82F6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          <div style="font-size: 16px; font-weight: 600; color: #111827;">Factuur wordt gedownload...</div>
          <div style="font-size: 14px; color: #6B7280; text-align: center;">Even geduld alstublieft</div>
        `;
        
        // Add spin animation
        if (!document.querySelector('#invoice-spin-animation')) {
          const style = document.createElement('style');
          style.id = 'invoice-spin-animation';
          style.textContent = `
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
          `;
          document.head.appendChild(style);
        }
        
        overlay.appendChild(spinnerBox);
        document.body.appendChild(overlay);
        
        // Store reference globally for cleanup
        window._currentInvoiceLoadingNotification = overlay;
        
        // DEBUG: Log everything
        
        // Force immediate display - multiple methods
        overlay.style.display = 'flex';
        overlay.style.opacity = '1';
        overlay.style.visibility = 'visible';
        
        // Verify it's actually visible
        setTimeout(() => {
          const rect = overlay.getBoundingClientRect();
          
          if (rect.width === 0 || rect.height === 0) {
            overlay.style.display = 'flex';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.zIndex = '99999999';
            overlay.style.background = 'rgba(0, 0, 0, 0.5)';
          }
        }, 50);
        
        try {
          // Show loading state on button
          const icon = this.querySelector('i');
          if (icon) {
            icon.className = 'fas fa-spinner fa-spin';
          }
          this.style.pointerEvents = 'none';
          
          
          // Fetch PDF
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Accept': 'application/pdf'
            }
          });
          
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          // Get PDF as blob
          const blob = await response.blob();
          
          // Create download link and trigger download
          const downloadUrl = window.URL.createObjectURL(blob);
          const downloadLink = document.createElement('a');
          downloadLink.href = downloadUrl;
          
          // Get filename from Content-Disposition header or use default
          const contentDisposition = response.headers.get('Content-Disposition');
          let filename = `factuur-${paymentId || 'download'}.pdf`;
          if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
            if (filenameMatch && filenameMatch[1]) {
              filename = filenameMatch[1].replace(/['"]/g, '');
              try {
                filename = decodeURIComponent(filename);
              } catch (e) {
                // Keep original if decode fails
              }
            }
          }
          
          downloadLink.download = filename;
          downloadLink.style.display = 'none';
          document.body.appendChild(downloadLink);
          
          downloadLink.click();
          
          // Cleanup
          setTimeout(() => {
            document.body.removeChild(downloadLink);
            window.URL.revokeObjectURL(downloadUrl);
          }, 100);
          
          // Remove loading overlay
          const overlayToRemove = document.getElementById(overlayId) || window._currentInvoiceLoadingNotification || overlay;
          
          if (overlayToRemove && overlayToRemove.parentNode) {
            overlayToRemove.style.opacity = '0';
            overlayToRemove.style.transition = 'opacity 0.3s ease';
            setTimeout(() => {
              if (overlayToRemove.parentNode) {
                overlayToRemove.parentNode.removeChild(overlayToRemove);
              }
            }, 300);
          } else {
          }
          window._currentInvoiceLoadingNotification = null;
          
          
          // Show success notification
          if (typeof window.showNotification === 'function') {
            window.showNotification('Factuur gedownload', 'success', 3000);
          }
          
          // Reset icon
          if (icon) {
            icon.className = 'fas fa-download';
          }
          this.style.pointerEvents = 'auto';
          
        } catch (error) {
          
          // Remove loading overlay
          const overlayToRemove = document.getElementById(overlayId) || window._currentInvoiceLoadingNotification || overlay;
          if (overlayToRemove && overlayToRemove.parentNode) {
            overlayToRemove.style.opacity = '0';
            overlayToRemove.style.transition = 'opacity 0.3s ease';
            setTimeout(() => {
              if (overlayToRemove.parentNode) {
                overlayToRemove.parentNode.removeChild(overlayToRemove);
              }
            }, 300);
          }
          window._currentInvoiceLoadingNotification = null;
          
          // Show error notification
          if (typeof window.showNotification === 'function') {
            window.showNotification('Er is een fout opgetreden bij het downloaden van de factuur. Probeer het opnieuw.', 'error', 5000);
          } else {
            alert('Er is een fout opgetreden bij het downloaden van de factuur. Probeer het opnieuw.');
          }
          
          // Reset icon
          const icon = this.querySelector('i');
          if (icon) {
            icon.className = 'fas fa-download';
          }
          this.style.pointerEvents = 'auto';
        }
      });
    });
  }
  
  // Setup immediately if DOM is ready, otherwise wait
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupInvoiceDownloadButtons);
  } else {
    setupInvoiceDownloadButtons();
  }
  
  // Also setup for dynamically added buttons
  const observer = new MutationObserver(() => {
    setupInvoiceDownloadButtons();
  });
  observer.observe(document.body, { childList: true, subtree: true });
</script>

<style>
.download-invoice-btn:hover {
  color: #3B82F6 !important;
  background-color: #EFF6FF !important;
}

.download-invoice-btn {
  position: relative;
}

.download-invoice-btn::after {
  content: attr(title);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  margin-bottom: 8px;
  padding: 6px 10px;
  background-color: #1F2937;
  color: #FFFFFF;
  font-size: 12px;
  white-space: nowrap;
  border-radius: 4px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
  z-index: 999999 !important;
}

.download-invoice-btn:hover::after {
  opacity: 1;
}

.download-invoice-btn::before {
  content: '';
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  margin-bottom: 2px;
  border: 4px solid transparent;
  border-top-color: #1F2937;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
  z-index: 999999 !important;
}

.download-invoice-btn:hover::before {
  opacity: 1;
}

/* Payments table typography overrides */
#allPaymentsTable thead th {
  font-size: 14px !important;
  color: #374151 !important;
}

#allPaymentsTable tbody td {
  font-size: 14px !important;
  color: #111827 !important;
}
</style>

<script>
  // Delegated fallback: ensure handler is always active
  document.addEventListener('click', async function(e) {
    const btn = e.target && e.target.closest && e.target.closest('.download-invoice-btn');
    if (!btn) return;
    if (btn.dataset.processing === 'true') return; // prevent double
    btn.dataset.processing = 'true';

    e.preventDefault();
    e.stopPropagation();

    try {
      const url = btn.getAttribute('href');
      const paymentId = btn.getAttribute('data-payment-id');
      if (!url) return;

      // Fullscreen overlay
      const overlayId = 'invoice-download-overlay-delegated-' + Date.now();
      const overlay = document.createElement('div');
      overlay.id = overlayId;
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99999999;display:flex;align-items:center;justify-content:center;';
      const box = document.createElement('div');
      box.style.cssText = 'background:#fff;border-radius:12px;padding:32px 40px;box-shadow:0 20px 40px rgba(0,0,0,.3);display:flex;flex-direction:column;align-items:center;gap:16px;min-width:280px;';
      box.innerHTML = '<div style="width:48px;height:48px;border:4px solid #E5E7EB;border-top-color:#3B82F6;border-radius:50%;animation:spin 1s linear infinite"></div><div style="font-size:16px;font-weight:600;color:#111827">Factuur wordt gedownload...</div><div style="font-size:14px;color:#6B7280;text-align:center">Even geduld alstublieft</div>';
      if (!document.querySelector('#invoice-spin-animation')) {
        const s = document.createElement('style');
        s.id = 'invoice-spin-animation';
        s.textContent = '@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}';
        document.head.appendChild(s);
      }
      overlay.appendChild(box);
      document.body.appendChild(overlay);

      // Swap icon to spinner
      const icon = btn.querySelector('i');
      if (icon) icon.className = 'fas fa-spinner fa-spin';
      btn.style.pointerEvents = 'none';

      const res = await fetch(url, { method: 'GET', headers: { Accept: 'application/pdf' } });
      if (!res.ok) throw new Error('HTTP '+res.status);
      const blob = await res.blob();

      const dlUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = dlUrl;
      a.download = `factuur-${paymentId||'download'}.pdf`;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(dlUrl); },100);

      // Cleanup overlay
      if (overlay && overlay.parentNode) {
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity .25s ease';
        setTimeout(()=>{ if (overlay.parentNode) overlay.parentNode.removeChild(overlay); }, 250);
      }
      if (typeof window.showNotification==='function') window.showNotification('Factuur gedownload','success',3000);
      if (icon) icon.className = 'fas fa-download';
      btn.style.pointerEvents = 'auto';
    } catch (err) {
      const anyOverlay = document.querySelector('[id^="invoice-download-overlay-"]');
      if (anyOverlay && anyOverlay.parentNode) anyOverlay.parentNode.removeChild(anyOverlay);
      if (typeof window.showNotification==='function') window.showNotification('Fout bij downloaden van factuur','error',5000);
      btn.style.pointerEvents = 'auto';
    } finally {
      btn.dataset.processing = 'false';
    }
  }, true);
</script>
